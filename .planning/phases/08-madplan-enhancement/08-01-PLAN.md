---
phase: 08-madplan-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - madplan-v2/src/components/ugeplan/week-picker.tsx
  - madplan-v2/src/components/ugeplan/recipe-picker.tsx
  - madplan-v2/src/app/ugeplan/page.tsx
  - madplan-v2/src/hooks/use-ugeplan.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can select a future week when adding a meal via RecipePicker"
    - "Selected week is pre-selected to current week by default"
    - "Meal is added to the selected week, not the currently displayed week"
    - "After adding to a different week, that week's data is invalidated for fresh fetch"
  artifacts:
    - path: "madplan-v2/src/components/ugeplan/week-picker.tsx"
      provides: "Horizontal week tile selector component"
      exports: ["WeekPicker"]
    - path: "madplan-v2/src/components/ugeplan/recipe-picker.tsx"
      provides: "Updated drawer with week selection"
      contains: "WeekPicker"
    - path: "madplan-v2/src/hooks/use-ugeplan.ts"
      provides: "Cross-week meal addition support"
      contains: "addDayToWeek"
  key_links:
    - from: "recipe-picker.tsx"
      to: "week-picker.tsx"
      via: "component import and render"
      pattern: "import.*WeekPicker"
    - from: "recipe-picker.tsx"
      to: "onSelect callback"
      via: "passes selectedWeek with recipe selection"
      pattern: "onSelect.*selectedWeek"
    - from: "use-ugeplan.ts"
      to: "/api/madplan/dag"
      via: "POST with week context"
      pattern: "aar.*uge"
---

<objective>
Add week picker to the RecipePicker drawer so users can add meals to any week (not just the currently displayed week).

Purpose: Fixes BUG-04 - currently users can only add meals to the week they're viewing, which is frustrating when planning ahead.
Output: Week picker component integrated into RecipePicker, with proper callback to add meals to selected week.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-madplan-enhancement/08-CONTEXT.md
@.planning/phases/08-madplan-enhancement/08-RESEARCH.md

@madplan-v2/src/components/ugeplan/recipe-picker.tsx
@madplan-v2/src/app/ugeplan/page.tsx
@madplan-v2/src/hooks/use-ugeplan.ts
@madplan-v2/src/lib/week-utils.ts
@madplan-v2/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WeekPicker component</name>
  <files>madplan-v2/src/components/ugeplan/week-picker.tsx</files>
  <action>
Create a new WeekPicker component that displays 4 horizontal week tiles:

1. Use existing week-utils.ts functions (getCurrentWeek, navigateWeek)
2. Generate 4 weeks: current week + 3 future weeks
3. Label format per CONTEXT.md:
   - Week 0: "Denne uge"
   - Week +1: "Naeste uge"
   - Week +2, +3: "Uge {weekNumber}"
4. Horizontal row layout with flexbox, gap-2
5. Each tile is a button with:
   - Selected state (ring-2 ring-terracotta-500)
   - Unselected state (border border-input hover:bg-accent)
   - Compact padding (px-3 py-2)
6. Props:
   - selectedWeek: { aar: number; uge: number }
   - onWeekChange: (week: { aar: number; uge: number }) => void

Style tiles to feel tappable on mobile (min-h-[44px] touch target).
  </action>
  <verify>Component renders 4 week tiles, clicking changes selection, correct labels shown</verify>
  <done>"Denne uge" selected by default, clicking other weeks updates selection state</done>
</task>

<task type="auto">
  <name>Task 2: Integrate WeekPicker into RecipePicker and update callbacks</name>
  <files>madplan-v2/src/components/ugeplan/recipe-picker.tsx, madplan-v2/src/app/ugeplan/page.tsx, madplan-v2/src/hooks/use-ugeplan.ts</files>
  <action>
Update RecipePicker to include week selection:

1. In recipe-picker.tsx:
   - Add state for selectedWeek (default to current week from week-utils)
   - Import and render WeekPicker below DrawerHeader, above search
   - Update onSelect prop signature: onSelect(ret, opskriftId, selectedWeek)
   - Pass selectedWeek when calling onSelect in handleSelect
   - Reset selectedWeek to current week when drawer closes (in useEffect on open)

2. In use-ugeplan.ts:
   - Add new method addDayToWeek(targetWeek, dag, ret, opskriftId) that:
     - Makes POST to /api/madplan/dag with target week's aar/uge
     - On success, calls mutate() to refresh current week data
     - If targetWeek differs from current hook's week, also invalidate that week's SWR cache key
   - Use SWR's global mutate for cross-week invalidation: import { mutate as globalMutate } from 'swr'

3. In ugeplan/page.tsx:
   - Update handleSelectMeal to receive (ret, opskriftId, selectedWeek)
   - If selectedWeek matches current displayed week, use existing updateDay
   - If selectedWeek differs, use new addDayToWeek method
   - Show toast with week info: `${ret} tilfojet til uge ${selectedWeek.uge}`

Important: The API POST body structure already includes aar/uge via the ugeplan ID lookup. For cross-week adds, we need to find/create the target week's ugeplan first. Check if API supports creating ugeplan on demand, or if the workflow handles it.
  </action>
  <verify>
    1. npm run build passes
    2. Open RecipePicker, see week tiles above search
    3. Select future week, select recipe, toast shows correct week
    4. Navigate to that future week, meal appears
  </verify>
  <done>Users can add meals to any of 4 weeks from RecipePicker, meals persist correctly</done>
</task>

</tasks>

<verification>
- [ ] WeekPicker shows 4 weeks with correct labels
- [ ] Current week pre-selected when drawer opens
- [ ] Selecting different week and adding meal works
- [ ] Meal appears when navigating to target week
- [ ] Toast message indicates which week received the meal
- [ ] No TypeScript errors, build passes
</verification>

<success_criteria>
1. BUG-04 resolved: Users can add meals to current + 3 future weeks
2. Week picker has clear visual selection state
3. Meals added to non-current weeks persist and show correctly
4. No regression in existing meal add functionality
</success_criteria>

<output>
After completion, create `.planning/phases/08-madplan-enhancement/08-01-SUMMARY.md`
</output>
