---
phase: 08-madplan-enhancement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - madplan-v2/src/lib/types.ts
  - madplan-v2/src/hooks/use-ugeplan.ts
  - madplan-v2/src/components/ugeplan/day-card.tsx
  - madplan-v2/src/app/ugeplan/page.tsx
autonomous: true
user_setup:
  - service: airtable
    why: "Add note fields to Madplan table schema"
    dashboard_config:
      - task: "Add 7 text fields to Madplan table: Mandag_Note, Tirsdag_Note, Onsdag_Note, Torsdag_Note, Fredag_Note, Loerdag_Note, Soendag_Note"
        location: "Airtable > Madplan table > Add field"

must_haves:
  truths:
    - "User can add/edit a short note on any meal entry"
    - "Note displays below recipe title on day card"
    - "Note persists after page refresh"
    - "Empty/no note shows nothing (no placeholder text in display)"
  artifacts:
    - path: "madplan-v2/src/lib/types.ts"
      provides: "DagEntry with optional note field"
      contains: "note?: string"
    - path: "madplan-v2/src/components/ugeplan/day-card.tsx"
      provides: "Note display and inline edit"
      contains: "entry.note"
    - path: "madplan-v2/src/hooks/use-ugeplan.ts"
      provides: "Note in update payload"
      contains: "note"
  key_links:
    - from: "day-card.tsx"
      to: "use-ugeplan.ts"
      via: "onNoteChange callback"
      pattern: "updateDay.*note"
    - from: "use-ugeplan.ts"
      to: "/api/madplan/dag"
      via: "POST body includes note"
      pattern: "note.*arg\\.note"
---

<objective>
Add note functionality to meal entries so users can add short hints like "Rest", "Fra frost", "Dobbelt portion".

Purpose: Implements FEAT-01 and FEAT-02 - users want to annotate meals with brief context without editing the recipe itself.
Output: Note field on DagEntry type, inline note input on day cards, persistence via existing API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-madplan-enhancement/08-CONTEXT.md
@.planning/phases/08-madplan-enhancement/08-RESEARCH.md

@madplan-v2/src/lib/types.ts
@madplan-v2/src/hooks/use-ugeplan.ts
@madplan-v2/src/components/ugeplan/day-card.tsx
@madplan-v2/src/app/ugeplan/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update types and hook for note support</name>
  <files>madplan-v2/src/lib/types.ts, madplan-v2/src/hooks/use-ugeplan.ts</files>
  <action>
1. In types.ts:
   - Add optional note field to DagEntry interface: note?: string

2. In use-ugeplan.ts:
   - Add note to UpdateDagArgs interface: note?: string
   - Update updateDay method signature to accept optional note parameter
   - Include note in the POST body when calling /api/madplan/dag
   - Add separate updateNote method for just updating the note:
     updateNote: async (dag: DagNavn, note: string) => {
       // Calls API to update just the note field
       // This allows note edits without re-sending ret/opskriftId
     }

Note: The n8n workflow "Madplan - Dag Opdater" needs to handle the note field. Check if it already passes through unknown fields to Airtable, or if it needs updating. If workflow update is needed, use n8n MCP tools to add note field handling.

Backend consideration: The Airtable fields should be named {Dag}_Note (e.g., Mandag_Note). The n8n workflow maps feltNavn to field name, so note field would be {feltNavn}_Note.
  </action>
  <verify>TypeScript compiles, types include note field</verify>
  <done>DagEntry has note?: string, hook methods support note parameter</done>
</task>

<task type="auto">
  <name>Task 2: Add note display and inline edit to DayCard</name>
  <files>madplan-v2/src/components/ugeplan/day-card.tsx, madplan-v2/src/app/ugeplan/page.tsx</files>
  <action>
1. In day-card.tsx:
   - Add onNoteChange prop: onNoteChange?: (note: string) => void
   - Display note below recipe title when present:
     {entry.note && (
       <p className="text-sm text-muted-foreground mt-0.5">{entry.note}</p>
     )}
   - Add inline note input (only when hasRet is true):
     - Small text input with placeholder "Tilfoej note..."
     - Use Input component with compact styling (h-7, text-sm)
     - Blur or Enter triggers onNoteChange
     - Max length ~50 chars (per CONTEXT.md "short hints only")
     - Position below recipe title, before action buttons
   - Use debounced update or blur-to-save pattern to avoid excessive API calls

2. In ugeplan/page.tsx:
   - Add handleNoteChange callback that calls updateNote from hook
   - Pass onNoteChange to DayCard components
   - Show subtle toast on note save: "Note gemt" (brief, non-intrusive)

Design per CONTEXT.md:
- Inline text field, NOT modal or tap-to-expand
- Keep it unobtrusive - note input should not dominate the card
- Empty state shows placeholder in input, no text in display area
  </action>
  <verify>
    1. Note displays below recipe title
    2. Typing in note field and blurring saves note
    3. Refreshing page shows saved note
    4. Note field only appears when there's a meal
  </verify>
  <done>Notes can be added, display correctly, persist across refresh</done>
</task>

<task type="auto">
  <name>Task 3: Update n8n workflow for note persistence</name>
  <files>n8n workflow via MCP</files>
  <action>
Use n8n MCP tools to update the "Madplan - Dag Opdater" workflow:

1. First, use n8n_list_workflows to find the workflow ID for "Madplan - Dag Opdater"

2. Use n8n_get_workflow to inspect current structure

3. Modify the workflow to:
   - Accept `note` in the incoming webhook/trigger data
   - Map note to `{feltNavn}_Note` field in Airtable update
   - Example: if feltNavn is "Mandag" and note is "Rest", update Mandag_Note = "Rest"
   - Handle case where note is empty string (clear the note)

4. Use n8n_update_workflow to deploy changes

5. Test with curl or the app to verify note persistence

If the workflow already passes through all fields dynamically, this task may just need verification. Check the Airtable node configuration.
  </action>
  <verify>
    1. POST to /api/madplan/dag with note field persists to Airtable
    2. GET returns note in response
    3. Empty note clears the field
  </verify>
  <done>n8n workflow accepts and persists note field to Airtable</done>
</task>

</tasks>

<verification>
- [ ] DagEntry type includes note?: string
- [ ] Note field appears on day cards with meals
- [ ] Typing note and leaving field saves it
- [ ] Notes display below recipe title
- [ ] Notes persist after page refresh
- [ ] n8n workflow handles note field
- [ ] Empty notes clear the field (don't show "undefined")
- [ ] Build passes, no TypeScript errors
</verification>

<success_criteria>
1. FEAT-01 resolved: Users can add short notes to meal entries
2. FEAT-02 resolved: Notes display under recipe title on ugeplan
3. Notes are brief (hints like "Rest", "Fra frost") as intended
4. End-to-end persistence works: frontend -> API -> n8n -> Airtable -> back
</success_criteria>

<output>
After completion, create `.planning/phases/08-madplan-enhancement/08-02-SUMMARY.md`
</output>
