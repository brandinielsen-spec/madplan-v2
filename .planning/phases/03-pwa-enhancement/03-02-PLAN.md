---
phase: 03-pwa-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - madplan-v2/src/app/ugeplan/page.tsx
  - madplan-v2/src/components/ugeplan/week-nav.tsx
  - madplan-v2/src/lib/week-utils.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can swipe left/right to change week"
    - "Swipe works smoothly without triggering browser back"
    - "Visual feedback during swipe (slide animation)"
    - "Arrow buttons trigger same animation as swipe"
    - "Hard stop at week boundaries (4 weeks past, 4 weeks future)"
  artifacts:
    - path: "madplan-v2/src/app/ugeplan/page.tsx"
      provides: "Ugeplan page with swipeable week carousel"
      contains: "WeekSwiper"
    - path: "madplan-v2/src/components/ugeplan/week-nav.tsx"
      provides: "Week navigation header synced with carousel"
      contains: "onPrev.*onNext"
    - path: "madplan-v2/src/lib/week-utils.ts"
      provides: "Week calculation utilities including range generation"
      exports: ["getWeeksInRange", "getWeekOffset"]
  key_links:
    - from: "page.tsx"
      to: "week-swiper.tsx"
      via: "WeekSwiper wraps week slides"
      pattern: "<WeekSwiper"
    - from: "page.tsx"
      to: "week-nav.tsx"
      via: "WeekNav syncs with carousel index"
      pattern: "onPrev.*scrollPrev|onNext.*scrollNext"
    - from: "week-nav.tsx"
      to: "carousel navigation"
      via: "button clicks call scroll functions"
      pattern: "onClick.*scroll(Prev|Next)"
---

<objective>
Integrate swipe gestures into the Ugeplan page to enable week navigation via swiping.

Purpose: Replace the button-only week navigation with a swipeable carousel that feels native. Users can swipe left/right to navigate weeks, and arrow buttons trigger the same slide animation.

Output: Ugeplan page uses WeekSwiper with 9 pre-loaded weeks (current +/- 4), WeekNav synced with carousel state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pwa-enhancement/03-CONTEXT.md
@.planning/phases/03-pwa-enhancement/03-RESEARCH.md
@.planning/phases/03-pwa-enhancement/03-01-SUMMARY.md

# Key existing files
@madplan-v2/src/app/ugeplan/page.tsx
@madplan-v2/src/components/ugeplan/week-nav.tsx
@madplan-v2/src/components/ugeplan/day-card.tsx
@madplan-v2/src/lib/week-utils.ts
@madplan-v2/src/hooks/use-ugeplan.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add week range utilities to week-utils.ts</name>
  <files>
    madplan-v2/src/lib/week-utils.ts
  </files>
  <action>
    Add new utility functions to `src/lib/week-utils.ts`:

    1. `getWeeksInRange(centerWeek: {aar: number, uge: number}, range: number)`:
       - Returns array of {aar, uge} for weeks from -range to +range
       - Example: range=4 returns 9 weeks (current +/- 4)
       - Use navigateWeek internally for correct year boundary handling

    2. `getWeekOffset(from: {aar, uge}, to: {aar, uge})`:
       - Returns number of weeks between two week references
       - Positive if 'to' is after 'from', negative otherwise
       - Used to calculate slide index from week change

    3. `isSameWeek(a: {aar, uge}, b: {aar, uge})`:
       - Returns true if both refer to same week
       - Simple equality check on aar and uge

    These utilities support the carousel which pre-loads 9 weeks and maps slide index to week.
  </action>
  <verify>
    - `getWeeksInRange({aar: 2026, uge: 4}, 4)` returns array of 9 weeks
    - `getWeekOffset({aar: 2026, uge: 4}, {aar: 2026, uge: 6})` returns 2
    - TypeScript compiles without errors
  </verify>
  <done>
    Week range utilities added for carousel week mapping
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor Ugeplan page with WeekSwiper carousel</name>
  <files>
    madplan-v2/src/app/ugeplan/page.tsx
    madplan-v2/src/components/ugeplan/week-nav.tsx
  </files>
  <action>
    1. Update `src/app/ugeplan/page.tsx`:
       - Import WeekSwiper, WeekSlide from ugeplan components
       - Import getWeeksInRange, isSameWeek from week-utils
       - Generate 9 weeks array using getWeeksInRange(currentWeek, 4)
       - Use useRef to get WeekSwiper imperative handle (or pass callbacks as props)
       - Replace the day cards list with WeekSwiper containing 9 WeekSlide children
       - Each WeekSlide renders DayCard list for that week
       - On slide change callback: update week state to match selected slide
       - Pass scrollPrev/scrollNext to WeekNav as onPrev/onNext

    2. Update `src/components/ugeplan/week-nav.tsx`:
       - Add canPrev, canNext props (boolean)
       - Disable prev button when canPrev is false (at boundary)
       - Disable next button when canNext is false (at boundary)
       - Buttons now call the carousel scroll functions passed via props

    Key behavior per CONTEXT.md:
    - 9 weeks total: 4 past + current + 4 future
    - Current week starts at slide index 4 (center)
    - Hard stop at boundaries (canPrev/canNext = false at edges)
    - Arrow buttons trigger same slide animation as swipe

    Data loading strategy:
    - Load data for visible week only (useUgeplan with current week state)
    - When slide changes, update week state which triggers data fetch
    - Consider: pre-fetch adjacent weeks for instant display (optional optimization)
  </action>
  <verify>
    - Page renders WeekSwiper with 9 slides
    - Swiping changes the displayed week
    - Arrow buttons disabled at week boundaries
    - Week label in header updates when week changes
    - `npm run build` succeeds
  </verify>
  <done>
    Ugeplan page uses swipeable carousel for week navigation with synced header
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Swipeable week navigation on Ugeplan page</what-built>
  <how-to-verify>
    1. Start dev server: `cd madplan-v2 && npm run dev`
    2. Open http://localhost:3000/ugeplan on mobile or desktop
    3. Test swipe gestures:
       - Swipe left: should show next week with slide animation
       - Swipe right: should show previous week with slide animation
       - Incomplete swipe (< 30%): should snap back to current week
    4. Test boundaries:
       - Swipe to earliest week (4 weeks back): should hit hard stop
       - Swipe to latest week (4 weeks forward): should hit hard stop
       - Arrow buttons should be disabled at boundaries
    5. Test arrow buttons:
       - Tap prev/next arrows: should trigger same animation as swipe
    6. Test on iOS Safari (if available):
       - Swipe should NOT trigger browser back gesture
       - Vertical scroll within week should work normally

    Expected: Smooth, native iOS-like swipe experience with slide transitions.
  </how-to-verify>
  <resume-signal>Type "approved" if swipe works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Type check: `cd madplan-v2 && npx tsc --noEmit` passes
2. Build check: `cd madplan-v2 && npm run build` succeeds
3. Manual test: Swipe gestures work on Ugeplan page
4. Boundary test: Cannot swipe past 4 weeks in either direction
</verification>

<success_criteria>
1. User can swipe left/right on Ugeplan page to change week
2. Swipe animation is smooth with slide transition (native iOS feel)
3. Incomplete swipe snaps back to current week
4. Arrow buttons trigger same animation as swipe
5. Hard stop at week boundaries (4 weeks past/future)
6. Swipe does not trigger browser back gesture on iOS Safari
7. Week label in header updates after swipe completes
</success_criteria>

<output>
After completion, create `.planning/phases/03-pwa-enhancement/03-02-SUMMARY.md`
</output>
