---
phase: 03-pwa-enhancement
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - madplan-v2/public/sw.js
  - madplan-v2/src/lib/sw-register.ts
  - madplan-v2/src/hooks/use-online-status.ts
  - madplan-v2/src/components/layout/offline-banner.tsx
  - madplan-v2/src/providers/swr-provider.tsx
  - madplan-v2/src/app/layout.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Service worker registers and caches API responses"
    - "App shows cached data when offline"
    - "Offline banner appears when user is offline"
    - "SWR cache persists to localStorage"
  artifacts:
    - path: "madplan-v2/public/sw.js"
      provides: "Service worker with network-first API caching"
      contains: "addEventListener.*fetch"
    - path: "madplan-v2/src/lib/sw-register.ts"
      provides: "Service worker registration utility"
      exports: ["registerServiceWorker"]
    - path: "madplan-v2/src/hooks/use-online-status.ts"
      provides: "Hook for tracking online/offline status"
      exports: ["useOnlineStatus"]
    - path: "madplan-v2/src/components/layout/offline-banner.tsx"
      provides: "Persistent banner when offline"
      exports: ["OfflineBanner"]
    - path: "madplan-v2/src/providers/swr-provider.tsx"
      provides: "SWR provider with localStorage cache persistence"
      contains: "localStorageProvider"
  key_links:
    - from: "layout.tsx"
      to: "sw-register.ts"
      via: "useEffect calling registerServiceWorker"
      pattern: "registerServiceWorker"
    - from: "swr-provider.tsx"
      to: "localStorage"
      via: "cache provider saves/restores cache"
      pattern: "localStorage.*madplan-cache"
    - from: "offline-banner.tsx"
      to: "use-online-status.ts"
      via: "hook provides isOnline state"
      pattern: "useOnlineStatus"
---

<objective>
Implement service worker caching and offline support for the Madplan PWA.

Purpose: Enable read-only offline access to cached meal plan data. When offline, users see their cached data and a subtle banner indicating offline status. This completes the PWA enhancement phase.

Output: Service worker with network-first caching, localStorage SWR cache persistence, offline status hook, offline banner component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pwa-enhancement/03-CONTEXT.md
@.planning/phases/03-pwa-enhancement/03-RESEARCH.md

# Key existing files
@madplan-v2/src/providers/swr-provider.tsx
@madplan-v2/src/app/layout.tsx
@madplan-v2/src/app/manifest.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create service worker and registration utility</name>
  <files>
    madplan-v2/public/sw.js
    madplan-v2/src/lib/sw-register.ts
  </files>
  <action>
    1. Create `public/sw.js` with:
       - CACHE_NAME constant ('madplan-v1')
       - STATIC_ASSETS array: ['/', '/ugeplan', '/opskrifter', '/indkob', '/tilfoej']
       - install event: cache static assets, call skipWaiting()
       - activate event: clean old caches, call clients.claim()
       - fetch event handler with routing:
         - /api/* routes: network-first strategy (try network, fall back to cache)
         - document requests: network-first strategy
         - other assets: cache-first strategy
       - networkFirst helper function:
         - Try fetch, clone response and cache it
         - On failure, return cached response
         - If no cache, return 503 offline response
       - cacheFirst helper function:
         - Try cache first, fall back to network
       - message event listener for PREFETCH_WEEK messages (pre-cache API URLs)

    2. Create `src/lib/sw-register.ts`:
       - Export registerServiceWorker function
       - Guard: check typeof window and 'serviceWorker' in navigator
       - Register '/sw.js' with scope '/' on window load event
       - Set updateViaCache: 'none' to ensure updates are detected
       - Log registration success/failure

    Reference 03-RESEARCH.md "Service Worker with Prefetching" pattern.

    Key per CONTEXT.md:
    - Network-first for API (always try fresh data first)
    - Read-only when offline (cache serves data, mutations fail gracefully)
  </action>
  <verify>
    - `public/sw.js` exists with fetch event handler
    - `src/lib/sw-register.ts` exports registerServiceWorker
    - sw.js handles /api/ routes with network-first
    - sw.js has skipWaiting() and clients.claim()
  </verify>
  <done>
    Service worker created with network-first API caching and registration utility
  </done>
</task>

<task type="auto">
  <name>Task 2: Create offline status hook and banner component</name>
  <files>
    madplan-v2/src/hooks/use-online-status.ts
    madplan-v2/src/components/layout/offline-banner.tsx
  </files>
  <action>
    1. Create `src/hooks/use-online-status.ts`:
       - Use useSyncExternalStore for proper React 18+ subscription
       - subscribe function: add 'online'/'offline' event listeners, return cleanup
       - getSnapshot function: return navigator.onLine
       - getServerSnapshot function: return true (assume online during SSR)
       - Export useOnlineStatus hook returning boolean isOnline

    2. Create `src/components/layout/offline-banner.tsx`:
       - Import useOnlineStatus hook
       - State for showBanner (boolean)
       - useEffect with debounce: when offline, wait 2 seconds before showing banner
       - When online again, hide banner immediately
       - Render: fixed positioned banner at top, subtle amber/yellow styling
       - Text: "Du er offline" (Danish)
       - z-index high enough to be above header
       - Return null if !showBanner

    Reference 03-RESEARCH.md patterns:
    - "Online Status Hook" for useSyncExternalStore pattern
    - "Offline Banner Component" for debounce logic
    - Pitfall 5: Debounce offline status to prevent flashing on unstable connections
  </action>
  <verify>
    - `src/hooks/use-online-status.ts` exports useOnlineStatus
    - `src/components/layout/offline-banner.tsx` exports OfflineBanner
    - Banner has 2-second debounce before appearing
    - Banner uses amber/yellow styling matching app theme
  </verify>
  <done>
    Offline status hook and banner component created with debounce
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate offline support into app</name>
  <files>
    madplan-v2/src/providers/swr-provider.tsx
    madplan-v2/src/app/layout.tsx
  </files>
  <action>
    1. Update `src/providers/swr-provider.tsx`:
       - Add localStorageProvider function:
         - Guard for typeof window === 'undefined' (return empty Map for SSR)
         - On init: restore cache from localStorage.getItem('madplan-cache')
         - Parse as JSON array of entries, create Map
         - Add beforeunload listener: save map to localStorage as JSON
         - Return the map
       - Add provider to SWRConfig value: { provider: localStorageProvider }
       - Keep existing settings (revalidateOnFocus: false, etc.)

    2. Update `src/app/layout.tsx`:
       - Import registerServiceWorker from '@/lib/sw-register'
       - Import OfflineBanner from '@/components/layout/offline-banner'
       - Create a client component wrapper (ServiceWorkerRegistration) that:
         - Uses useEffect to call registerServiceWorker on mount
         - Returns null (no UI)
       - Add ServiceWorkerRegistration inside body
       - Add OfflineBanner at top of body (before children)

    Key per CONTEXT.md:
    - Pre-cache current week + next week on first load
    - Refresh cached data when app comes to foreground (revalidateOnFocus handles this, but it's disabled - consider enabling for foreground refresh or rely on navigation)

    Note: The SWR localStorage cache ensures data persists across sessions. Combined with service worker API caching, this provides robust offline fallback.
  </action>
  <verify>
    - SWRProvider includes localStorageProvider in config
    - layout.tsx registers service worker on mount
    - layout.tsx includes OfflineBanner component
    - `npm run build` succeeds
  </verify>
  <done>
    App integrated with service worker registration, SWR localStorage cache, and offline banner
  </done>
</task>

</tasks>

<verification>
1. Type check: `cd madplan-v2 && npx tsc --noEmit` passes
2. Build check: `cd madplan-v2 && npm run build` succeeds
3. Service worker: Open DevTools > Application > Service Workers, verify sw.js registered
4. Offline test: In DevTools > Network, set to Offline, refresh page - should show cached data
5. Banner test: While offline, banner should appear after 2 seconds
</verification>

<success_criteria>
1. Service worker registers successfully
2. API responses are cached (visible in DevTools > Application > Cache Storage)
3. App shows cached data when offline
4. Offline banner appears after 2 seconds when offline
5. Banner disappears immediately when back online
6. SWR cache persists to localStorage (check localStorage in DevTools)
7. TypeScript compiles without errors
8. Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-pwa-enhancement/03-03-SUMMARY.md`
</output>
