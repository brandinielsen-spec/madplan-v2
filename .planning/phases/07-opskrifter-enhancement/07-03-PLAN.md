---
phase: 07-opskrifter-enhancement
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - madplan-v2/src/app/opskrifter/[id]/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Bruger ser 'Tilfoej til indkobsliste' knap paa opskrift-detalje"
    - "Klik paa knappen tilfojer alle ingredienser til indkobsliste"
    - "Toast viser feedback om antal tilfoejede ingredienser"
    - "Ingredienser vises i indkobsliste med opskrift-navn som kilde"
  artifacts:
    - path: "madplan-v2/src/app/opskrifter/[id]/page.tsx"
      provides: "Add to shopping list button"
      contains: "handleAddToShoppingList"
      min_lines: 250
  key_links:
    - from: "opskrifter/[id]/page.tsx"
      to: "use-indkobsliste.ts:addItems"
      via: "hook call with ingredienser array"
      pattern: "addItems.*ingredienser"
    - from: "use-indkobsliste.ts"
      to: "/api/madplan/indkob"
      via: "POST request per ingredient"
      pattern: "fetch.*api/madplan/indkob"
---

<objective>
Add "Tilfoej til indkobsliste" button to recipe detail page that adds all ingredients.

Purpose: Users want to add a recipe's ingredients to their shopping list with one click, without having to add the recipe to a meal plan first. This implements FEAT-03.

Output: Button on recipe detail page that adds all ingredients to the current week's shopping list.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-opskrifter-enhancement/07-RESEARCH.md

# Working pattern from ugeplan
@madplan-v2/src/app/ugeplan/page.tsx

# Files to modify
@madplan-v2/src/app/opskrifter/[id]/page.tsx

# Supporting code
@madplan-v2/src/hooks/use-indkobsliste.ts
@madplan-v2/src/lib/week-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Shopping List Button to Recipe Detail Page</name>
  <files>madplan-v2/src/app/opskrifter/[id]/page.tsx</files>
  <action>
Modify opskrifter/[id]/page.tsx to add the shopping list button:

1. Add imports at the top:
```typescript
import { ShoppingCart } from 'lucide-react'
import { useIndkobsliste } from '@/hooks/use-indkobsliste'
import { getCurrentWeek } from '@/lib/week-utils'
```

2. Inside the component, after the ejerId line, add week context and shopping list hook:
```typescript
// Get current week for shopping list
const { aar, uge } = getCurrentWeek()
const { addItems, isAddingMultiple } = useIndkobsliste(ejerId, aar, uge)
```

3. Add handler function (after handleRemoveTag):
```typescript
const handleAddToShoppingList = async () => {
  if (!opskrift?.ingredienser?.length) {
    toast.error('Opskriften har ingen ingredienser')
    return
  }

  const toastId = toast.loading(
    `Tilfojer ${opskrift.ingredienser.length} ingredienser...`,
    { duration: Infinity }
  )

  try {
    const { added, failed } = await addItems(opskrift.ingredienser, opskrift.titel)
    if (failed === 0) {
      toast.success(`${added} ingredienser tilfojet til indkob`, { id: toastId })
    } else if (added > 0) {
      toast.warning(`${added} af ${added + failed} tilfojet`, { id: toastId })
    } else {
      toast.error('Kunne ikke tilfoeje ingredienser', { id: toastId })
    }
  } catch {
    toast.error('Kunne ikke tilfoeje ingredienser', { id: toastId })
  }
}
```

4. Add button in the JSX, after the Ingredienser Card (around line 145):
```tsx
{/* Add to shopping list button */}
<Button
  onClick={handleAddToShoppingList}
  disabled={isAddingMultiple || !opskrift?.ingredienser?.length}
  className="w-full"
  variant="outline"
>
  <ShoppingCart className="h-4 w-4 mr-2" />
  Tilfoej til indkobsliste
</Button>
```

Place the button between the Ingredienser Card and the Fremgangsmaade Card.

5. Ensure the toast feedback uses Danish characters consistently (tilfoej not tilfoej).
  </action>
  <verify>
1. Run TypeScript compilation: `cd madplan-v2 && npm run build`
2. No TypeScript errors related to the changes
3. Start dev server and navigate to a recipe detail page
4. Verify button appears below ingredients list
5. Button should be disabled if recipe has no ingredients
  </verify>
  <done>
Button added to recipe detail page with correct hook integration and handler function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test Add to Shopping List Flow</name>
  <files>No file changes</files>
  <action>
Test the complete flow:

1. Start dev server: `cd madplan-v2 && npm run dev`

2. Navigate to a recipe with ingredients:
   - http://localhost:3000/opskrifter
   - Click on a recipe that has ingredients

3. Test the button:
   - Click "Tilfoej til indkobsliste"
   - Observe loading toast appears immediately
   - Wait for success toast with ingredient count

4. Verify ingredients added:
   - Navigate to /indkob
   - Verify all ingredients from the recipe appear in the list
   - Verify each item shows recipe name as source (e.g., "Fra: Pasta Carbonara")

5. Test edge cases:
   - Recipe with no ingredients: Button should be disabled
   - Click button twice quickly: Should not duplicate items (loading state prevents)
   - Network error: Should show error toast

6. Test week context:
   - Verify ingredients go to CURRENT week's shopping list
   - Check by navigating to indkob and confirming week matches
  </action>
  <verify>
Verification checklist:
- [ ] Button appears on recipe detail page below ingredients
- [ ] Loading toast shows with ingredient count
- [ ] Success toast shows after completion
- [ ] All ingredients appear in /indkob
- [ ] Each ingredient shows recipe name as kilde
- [ ] Button disabled while adding (prevents duplicates)
- [ ] Button disabled for recipes without ingredients
  </verify>
  <done>
FEAT-03 complete: Users can add recipe ingredients to shopping list with one click from recipe detail page.
  </done>
</task>

</tasks>

<verification>
Phase requirement verification:

| Requirement | How to Verify | Expected Result |
|-------------|---------------|-----------------|
| FEAT-03: Tilfoej til indkobsliste | Click button on recipe detail, check /indkob | All ingredients added with recipe name as source |
</verification>

<success_criteria>
1. Button visible on recipe detail page
2. Click adds all ingredients to current week's shopping list
3. Toast feedback shows progress and result
4. Ingredients show recipe name as kilde
5. Button disabled during loading (prevents double-click)
6. Button disabled for recipes without ingredients
</success_criteria>

<output>
After completion, create `.planning/phases/07-opskrifter-enhancement/07-03-SUMMARY.md`
</output>
