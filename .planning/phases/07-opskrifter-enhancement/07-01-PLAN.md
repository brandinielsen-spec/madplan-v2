---
phase: 07-opskrifter-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - n8n workflow (via MCP)
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Favorit toggle persists efter page refresh"
    - "Tags gemt via UI vises efter page refresh"
    - "Airtable Opskrifter records opdateres korrekt"
  artifacts:
    - path: "n8n workflow: madplan-opskrift-opdater"
      provides: "POST /madplan/opskrift/opdater endpoint"
      contains: "Airtable Update operation"
  key_links:
    - from: "/api/madplan/opskrift/favorit"
      to: "n8n /madplan/opskrift/opdater"
      via: "HTTP POST with opskriftId and fields"
      pattern: "POST.*fields.*Favorit"
    - from: "/api/madplan/opskrift/tags"
      to: "n8n /madplan/opskrift/opdater"
      via: "HTTP POST with opskriftId and fields"
      pattern: "POST.*fields.*Tags"
---

<objective>
Create or verify the n8n workflow that persists favorites and tags to Airtable.

Purpose: The frontend UI for favorites and tags works perfectly with optimistic updates, but changes are lost on refresh because the n8n backend endpoint `/madplan/opskrift/opdater` is missing or not responding. This plan fixes BUG-01 (favorites persistence) and BUG-02 (tags persistence).

Output: Working n8n workflow that accepts `{ opskriftId, fields }` and updates Airtable Opskrifter records.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-opskrifter-enhancement/07-RESEARCH.md

# Existing API routes that call n8n
@madplan-v2/src/app/api/madplan/opskrift/favorit/route.ts
@madplan-v2/src/app/api/madplan/opskrift/tags/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify or Create n8n Opdater Workflow</name>
  <files>n8n workflow via MCP tools</files>
  <action>
Use n8n MCP tools to:

1. List existing workflows to check if "madplan-opskrift-opdater" or similar exists:
   - Use `n8n_list_workflows` to see all workflows
   - Look for workflow handling `/madplan/opskrift/opdater`

2. If workflow does NOT exist, create it with `n8n_create_workflow`:

Workflow structure:
```
Webhook Trigger (POST /madplan/opskrift/opdater)
    |
    v
Airtable Update (Update record by ID)
    |
    v
Respond to Webhook (return success/error)
```

Webhook Node configuration:
- Method: POST
- Path: /madplan/opskrift/opdater
- Response Mode: "Response Node" (so we can control the response)

Airtable Node configuration:
- Operation: Update
- Base ID: Use existing pattern from other workflows (check existing madplan workflows)
- Table: Opskrifter
- Record ID: `{{ $json.opskriftId }}`
- Fields to Update: `{{ $json.fields }}` (dynamic - supports Favorit, Tags, or any field)

Respond Node configuration:
- Response Code: 200
- Response Body: `{ "success": true, "data": {{ $json }} }`

3. If workflow EXISTS but is inactive, activate it.

4. Validate the workflow using `n8n_validate_workflow` before activating.

IMPORTANT: Check existing madplan workflows for Airtable credentials/base ID to use the same configuration.
  </action>
  <verify>
Test the endpoint directly using curl or n8n_test_workflow:
```
POST ${N8N_WEBHOOK_URL}/madplan/opskrift/opdater
Content-Type: application/json

{
  "opskriftId": "recXXX",
  "fields": { "Favorit": true }
}
```

Expected response: 200 OK with success body.
  </verify>
  <done>
n8n workflow for /madplan/opskrift/opdater is active and responds to POST requests with Airtable updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test Favorites and Tags Persistence End-to-End</name>
  <files>n8n workflow, madplan-v2 app</files>
  <action>
Test the complete flow from frontend through backend:

1. Start the Next.js dev server if not running:
   ```
   cd madplan-v2 && npm run dev
   ```

2. Test favorites persistence:
   - Open http://localhost:3000/opskrifter
   - Find a recipe and click the heart icon
   - Observe optimistic update (heart fills immediately)
   - Refresh the page
   - Verify favorite state persists (heart should still be filled)

3. Test tags persistence:
   - Open a recipe detail page (http://localhost:3000/opskrifter/[id])
   - Add a tag using the tag input
   - Observe optimistic update (tag appears immediately)
   - Refresh the page
   - Verify tag persists

4. If persistence fails:
   - Check browser network tab for the API call
   - Check n8n workflow execution history using `n8n_list_executions`
   - Look for errors in Airtable field names (case sensitive!)

Common issues to check:
- Airtable field is "Favorit" (not "favorit" or "Favorite")
- Tags field is "Tags" and is multi-select type
- Record ID format matches Airtable (recXXX)
  </action>
  <verify>
Manual verification checklist:
1. Toggle favorite on recipe -> refresh -> favorite state persists
2. Add tag to recipe -> refresh -> tag persists
3. Remove tag from recipe -> refresh -> tag is gone
4. Network tab shows 200 responses for /api/madplan/opskrift/favorit and /tags
  </verify>
  <done>
BUG-01 and BUG-02 are fixed: Both favorites and tags persist to Airtable and survive page refresh.
  </done>
</task>

</tasks>

<verification>
Phase requirement verification:

| Requirement | How to Verify | Expected Result |
|-------------|---------------|-----------------|
| BUG-01: Favoritter gemmes | Toggle favorite, refresh, check state | Favorite state persists |
| BUG-02: Tags gemmes | Add tag, refresh, check tags | Tags persist |
</verification>

<success_criteria>
1. n8n workflow `/madplan/opskrift/opdater` is active and responding
2. POST with `{ opskriftId, fields: { Favorit: true } }` updates Airtable
3. POST with `{ opskriftId, fields: { Tags: [...] } }` updates Airtable
4. Frontend favorites toggle persists after page refresh
5. Frontend tag changes persist after page refresh
</success_criteria>

<output>
After completion, create `.planning/phases/07-opskrifter-enhancement/07-01-SUMMARY.md`
</output>
