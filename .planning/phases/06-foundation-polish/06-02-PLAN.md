---
phase: 06-foundation-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - madplan-v2/src/lib/types.ts
  - madplan-v2/src/hooks/use-indkobsliste.ts
  - madplan-v2/src/components/indkob/shopping-item.tsx
  - madplan-v2/src/components/ugeplan/day-card.tsx
autonomous: true

must_haves:
  truths:
    - "Shopping list items from recipes show the recipe name as source"
    - "Shopping list items added manually show 'Tilfojet manuelt'"
    - "Items from recipes without name data show 'Fra opskrift' as fallback"
  artifacts:
    - path: "madplan-v2/src/lib/types.ts"
      provides: "Extended Indkoebspost interface with kildeNavn"
      contains: "kildeNavn"
    - path: "madplan-v2/src/hooks/use-indkobsliste.ts"
      provides: "addItems function accepting source name"
      contains: "kildeNavn"
    - path: "madplan-v2/src/components/indkob/shopping-item.tsx"
      provides: "Source display logic"
      contains: "getSourceText"
  key_links:
    - from: "day-card.tsx"
      to: "use-indkobsliste.ts"
      via: "addItems call with recipe name"
      pattern: "addItems.*kildeNavn"
    - from: "shopping-item.tsx"
      to: "types.ts"
      via: "Indkoebspost interface"
      pattern: "item\\.kildeNavn"
---

<objective>
Show recipe name as source for shopping list items from meal plan.

Purpose: BUG-05 - Users cannot identify which recipe a shopping item came from. Currently all items show either "manuel" badge or nothing. Items from recipes should show the recipe name.

Output: Shopping list displays source correctly - recipe name for items from meal plan, "Tilfojet manuelt" for manual items.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-foundation-polish/06-RESEARCH.md
@madplan-v2/src/lib/types.ts
@madplan-v2/src/hooks/use-indkobsliste.ts
@madplan-v2/src/components/indkob/shopping-item.tsx
@madplan-v2/src/components/ugeplan/day-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend type and hook to support source name</name>
  <files>
madplan-v2/src/lib/types.ts
madplan-v2/src/hooks/use-indkobsliste.ts
  </files>
  <action>
1. In types.ts, extend Indkoebspost interface:
   ```typescript
   export interface Indkoebspost {
     id: string
     ejerId: string
     aar: number
     uge: number
     navn: string
     kilde: 'ret' | 'manuel'
     kildeNavn?: string  // NEW: Recipe name when kilde='ret', undefined for manual
     afkrydset: boolean
   }
   ```

2. In use-indkobsliste.ts, update addItems function signature and implementation:
   - Change function signature to accept optional kildeNavn:
     ```typescript
     const addItems = async (
       navne: string[],
       kildeNavn?: string
     ): Promise<{ added: number; failed: number }> => {
     ```
   - Pass kildeNavn in the POST body along with other fields:
     ```typescript
     body: JSON.stringify({
       ejerId,
       aar,
       uge,
       navn,
       kildeNavn  // Will be undefined for manual items, recipe name for recipe items
     }),
     ```

   Note: The n8n backend may or may not store kildeNavn. The frontend will handle gracefully either way.
  </action>
  <verify>
1. Run `npm run build` in madplan-v2 - should compile without TypeScript errors
2. Verify types.ts has kildeNavn property
3. Verify use-indkobsliste.ts addItems accepts kildeNavn parameter
  </verify>
  <done>
Indkoebspost type includes optional kildeNavn field.
addItems function accepts kildeNavn parameter and passes to API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update UI to display source and pass recipe name</name>
  <files>
madplan-v2/src/components/indkob/shopping-item.tsx
madplan-v2/src/components/ugeplan/day-card.tsx
  </files>
  <action>
1. In shopping-item.tsx, update to display source for ALL items (not just manual):
   - Remove the condition that only shows badge for kilde === 'manuel'
   - Add helper function to determine display text:
     ```typescript
     const getSourceText = () => {
       if (item.kilde === 'manuel') return 'Tilfojet manuelt'
       // For items from recipes, show recipe name if available
       if (item.kildeNavn) return item.kildeNavn
       return 'Fra opskrift'  // Fallback if kildeNavn not provided
     }
     ```
   - Display source as secondary text below item name:
     ```tsx
     <div className="flex-1 min-w-0">
       <span className={cn('text-base block', item.afkrydset && 'line-through text-muted-foreground')}>
         {item.navn}
       </span>
       <span className="text-xs text-muted-foreground">
         {getSourceText()}
       </span>
     </div>
     ```
   - Remove the Badge component (no longer needed)

2. In day-card.tsx, find where addItems is called when user taps the shopping cart icon:
   - Currently: `addItems(ingredienser)`
   - Update to: `addItems(ingredienser, entry.ret)` where entry.ret is the recipe/meal name
   - The addItems call is in handleAddToShoppingList or similar function
   - Look for the ShoppingCart button onClick handler
  </action>
  <verify>
1. Run `npm run build` in madplan-v2 - should compile without errors
2. Check that day-card.tsx passes recipe name to addItems
3. Check that shopping-item.tsx displays source text for all items
  </verify>
  <done>
Shopping list items show source: recipe name for items from meal plan, "Tilfojet manuelt" for manual items.
Day card passes recipe name when adding ingredients to shopping list.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. `npm run build` passes in madplan-v2 directory
2. Manual test flow:
   - Add ingredients from a recipe on ugeplan -> shopping list shows recipe name as source
   - Manually add item on shopping list -> shows "Tilfojet manuelt"
   - Items from recipes without kildeNavn stored -> shows "Fra opskrift" fallback
</verification>

<success_criteria>
- BUG-05: Shopping list items display correct source
- Items from meal plan recipes show the recipe name
- Manual items show "Tilfojet manuelt"
- Graceful fallback if backend doesn't return kildeNavn
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation-polish/06-02-SUMMARY.md`
</output>
