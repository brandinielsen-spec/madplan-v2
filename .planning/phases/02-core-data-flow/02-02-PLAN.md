---
phase: 02-core-data-flow
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - madplan-v2/.env.local
  - madplan-v2/src/app/api/madplan/ejere/route.ts
  - madplan-v2/src/app/api/madplan/uge/route.ts
  - madplan-v2/src/app/api/madplan/dag/route.ts
  - madplan-v2/src/app/api/madplan/opskrifter/route.ts
  - madplan-v2/src/app/api/madplan/indkob/route.ts
autonomous: false

user_setup:
  - service: n8n
    why: "API routes proxy to n8n webhooks - need base URL"
    env_vars:
      - name: N8N_WEBHOOK_URL
        source: "n8n Cloud instance URL (e.g., https://your-instance.app.n8n.cloud/webhook)"

must_haves:
  truths:
    - "API routes return data matching TypeScript types"
    - "n8n webhook URL is server-only (not exposed to client)"
    - "Error responses include meaningful messages"
  artifacts:
    - path: "madplan-v2/src/app/api/madplan/ejere/route.ts"
      provides: "GET /api/madplan/ejere proxy"
      exports: ["GET"]
    - path: "madplan-v2/src/app/api/madplan/uge/route.ts"
      provides: "GET /api/madplan/uge proxy"
      exports: ["GET"]
    - path: "madplan-v2/src/app/api/madplan/dag/route.ts"
      provides: "POST /api/madplan/dag proxy for update/delete"
      exports: ["POST"]
    - path: "madplan-v2/src/app/api/madplan/opskrifter/route.ts"
      provides: "GET /api/madplan/opskrifter proxy"
      exports: ["GET"]
    - path: "madplan-v2/src/app/api/madplan/indkob/route.ts"
      provides: "GET/POST/PUT /api/madplan/indkob proxy"
      exports: ["GET", "POST", "PUT"]
  key_links:
    - from: "API route files"
      to: "n8n webhooks"
      via: "process.env.N8N_WEBHOOK_URL + fetch"
      pattern: "N8N_WEBHOOK_URL"
---

<objective>
Create Next.js API routes that proxy requests to existing n8n workflows.

Purpose: Hide n8n webhook URLs from client bundle, provide consistent error handling, and enable future flexibility (swap backend without changing client).

Output: 5 API route files proxying to n8n endpoints for ejere, uge, dag, opskrifter, and indkob.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-data-flow/02-RESEARCH.md
@.planning/phases/02-core-data-flow/02-01-SUMMARY.md

# v1 workflow endpoints
@Madplan ver 1/README.md

# Types created in Plan 01
@madplan-v2/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .env.local template and API route directory structure</name>
  <files>madplan-v2/.env.local.example, madplan-v2/src/app/api/madplan/</files>
  <action>
Create `.env.local.example` as documentation (DO NOT create .env.local with real values - user will do that):

```
# n8n Webhook Base URL (server-only, no NEXT_PUBLIC_ prefix)
# Example: https://your-instance.app.n8n.cloud/webhook
N8N_WEBHOOK_URL=
```

Create the API route directory structure:
```
src/app/api/madplan/
  ejere/route.ts
  uge/route.ts
  dag/route.ts
  opskrifter/route.ts
  indkob/route.ts
```

IMPORTANT: Use process.env.N8N_WEBHOOK_URL (no NEXT_PUBLIC_ prefix) - this keeps the URL server-only.
  </action>
  <verify>
Check .env.local.example exists with the template.
Check directory structure exists: ls -la src/app/api/madplan/
  </verify>
  <done>
.env.local.example created. API route directories exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create API route handlers</name>
  <files>
    madplan-v2/src/app/api/madplan/ejere/route.ts
    madplan-v2/src/app/api/madplan/uge/route.ts
    madplan-v2/src/app/api/madplan/dag/route.ts
    madplan-v2/src/app/api/madplan/opskrifter/route.ts
    madplan-v2/src/app/api/madplan/indkob/route.ts
  </files>
  <action>
Create each route handler following this pattern:

**ejere/route.ts** - GET /api/madplan/ejere
```typescript
import { NextResponse } from 'next/server'

const N8N_BASE = process.env.N8N_WEBHOOK_URL

export async function GET() {
  if (!N8N_BASE) {
    return NextResponse.json({ error: 'N8N_WEBHOOK_URL not configured' }, { status: 500 })
  }

  try {
    const response = await fetch(`${N8N_BASE}/madplan/ejere`, {
      cache: 'no-store',
    })

    if (!response.ok) {
      return NextResponse.json({ error: 'Upstream error' }, { status: response.status })
    }

    const result = await response.json()
    return NextResponse.json(result.data ?? result)
  } catch (error) {
    console.error('GET /api/madplan/ejere error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```

**uge/route.ts** - GET /api/madplan/uge?ejerId=X&aar=Y&uge=Z
```typescript
import { NextRequest, NextResponse } from 'next/server'

const N8N_BASE = process.env.N8N_WEBHOOK_URL

export async function GET(request: NextRequest) {
  if (!N8N_BASE) {
    return NextResponse.json({ error: 'N8N_WEBHOOK_URL not configured' }, { status: 500 })
  }

  const { searchParams } = new URL(request.url)
  const ejerId = searchParams.get('ejerId')
  const aar = searchParams.get('aar')
  const uge = searchParams.get('uge')

  if (!ejerId || !aar || !uge) {
    return NextResponse.json({ error: 'Missing required parameters: ejerId, aar, uge' }, { status: 400 })
  }

  try {
    const response = await fetch(
      `${N8N_BASE}/madplan/uge?ejerId=${ejerId}&aar=${aar}&uge=${uge}`,
      { cache: 'no-store' }
    )

    if (!response.ok) {
      return NextResponse.json({ error: 'Upstream error' }, { status: response.status })
    }

    const result = await response.json()
    return NextResponse.json(result.data ?? result)
  } catch (error) {
    console.error('GET /api/madplan/uge error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```

**dag/route.ts** - POST /api/madplan/dag (handles both update and delete via action field)
```typescript
import { NextRequest, NextResponse } from 'next/server'

const N8N_BASE = process.env.N8N_WEBHOOK_URL

export async function POST(request: NextRequest) {
  if (!N8N_BASE) {
    return NextResponse.json({ error: 'N8N_WEBHOOK_URL not configured' }, { status: 500 })
  }

  try {
    const body = await request.json()
    const { action, ...data } = body

    // Route to appropriate n8n endpoint based on action
    const endpoint = action === 'slet' ? '/madplan/dag/slet' : '/madplan/dag/opdater'

    const response = await fetch(`${N8N_BASE}${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    })

    if (!response.ok) {
      const errorText = await response.text()
      return NextResponse.json(
        { error: 'Upstream error', details: errorText },
        { status: response.status }
      )
    }

    const result = await response.json()
    return NextResponse.json(result.data ?? result)
  } catch (error) {
    console.error('POST /api/madplan/dag error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```

**opskrifter/route.ts** - GET /api/madplan/opskrifter?ejerId=X
```typescript
import { NextRequest, NextResponse } from 'next/server'

const N8N_BASE = process.env.N8N_WEBHOOK_URL

export async function GET(request: NextRequest) {
  if (!N8N_BASE) {
    return NextResponse.json({ error: 'N8N_WEBHOOK_URL not configured' }, { status: 500 })
  }

  const { searchParams } = new URL(request.url)
  const ejerId = searchParams.get('ejerId')

  if (!ejerId) {
    return NextResponse.json({ error: 'Missing required parameter: ejerId' }, { status: 400 })
  }

  try {
    const response = await fetch(
      `${N8N_BASE}/madplan/opskrifter?ejerId=${ejerId}`,
      { cache: 'no-store' }
    )

    if (!response.ok) {
      return NextResponse.json({ error: 'Upstream error' }, { status: response.status })
    }

    const result = await response.json()
    return NextResponse.json(result.data ?? result)
  } catch (error) {
    console.error('GET /api/madplan/opskrifter error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```

**indkob/route.ts** - GET/POST/PUT /api/madplan/indkob
```typescript
import { NextRequest, NextResponse } from 'next/server'

const N8N_BASE = process.env.N8N_WEBHOOK_URL

// GET /api/madplan/indkob?ejerId=X&aar=Y&uge=Z
export async function GET(request: NextRequest) {
  if (!N8N_BASE) {
    return NextResponse.json({ error: 'N8N_WEBHOOK_URL not configured' }, { status: 500 })
  }

  const { searchParams } = new URL(request.url)
  const ejerId = searchParams.get('ejerId')
  const aar = searchParams.get('aar')
  const uge = searchParams.get('uge')

  if (!ejerId || !aar || !uge) {
    return NextResponse.json({ error: 'Missing required parameters: ejerId, aar, uge' }, { status: 400 })
  }

  try {
    const response = await fetch(
      `${N8N_BASE}/madplan/indkob?ejerId=${ejerId}&aar=${aar}&uge=${uge}`,
      { cache: 'no-store' }
    )

    if (!response.ok) {
      return NextResponse.json({ error: 'Upstream error' }, { status: response.status })
    }

    const result = await response.json()
    return NextResponse.json(result.data ?? result)
  } catch (error) {
    console.error('GET /api/madplan/indkob error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}

// POST /api/madplan/indkob - Add manual item
export async function POST(request: NextRequest) {
  if (!N8N_BASE) {
    return NextResponse.json({ error: 'N8N_WEBHOOK_URL not configured' }, { status: 500 })
  }

  try {
    const body = await request.json()

    const response = await fetch(`${N8N_BASE}/madplan/indkob/tilfoej`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    })

    if (!response.ok) {
      return NextResponse.json({ error: 'Upstream error' }, { status: response.status })
    }

    const result = await response.json()
    return NextResponse.json(result.data ?? result)
  } catch (error) {
    console.error('POST /api/madplan/indkob error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}

// PUT /api/madplan/indkob - Toggle item checked state
export async function PUT(request: NextRequest) {
  if (!N8N_BASE) {
    return NextResponse.json({ error: 'N8N_WEBHOOK_URL not configured' }, { status: 500 })
  }

  try {
    const body = await request.json()

    // Note: v1 may use a different endpoint for updates
    // Adjust endpoint as needed based on actual n8n workflow
    const response = await fetch(`${N8N_BASE}/madplan/indkob/opdater`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    })

    if (!response.ok) {
      return NextResponse.json({ error: 'Upstream error' }, { status: response.status })
    }

    const result = await response.json()
    return NextResponse.json(result.data ?? result)
  } catch (error) {
    console.error('PUT /api/madplan/indkob error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Run `npm run dev` and test one endpoint with curl:
`curl http://localhost:3000/api/madplan/ejere` - should return 500 (N8N_WEBHOOK_URL not set)
  </verify>
  <done>
All 5 API route files created. TypeScript compiles. Routes return 500 when N8N_WEBHOOK_URL not set.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Configure N8N_WEBHOOK_URL</name>
  <action>
User needs to create .env.local with their n8n webhook URL.

This step requires the user because:
1. The n8n instance URL is user-specific
2. This is sensitive configuration that should not be committed
  </action>
  <instructions>
1. Copy .env.local.example to .env.local
2. Set N8N_WEBHOOK_URL to your n8n webhook base URL
   - Format: https://your-instance.app.n8n.cloud/webhook
   - Find this in n8n: any workflow > webhook trigger > copy URL, remove the path after /webhook
3. Restart dev server (`npm run dev`)
4. Test with: `curl http://localhost:3000/api/madplan/ejere`
   - Should return your ejere data or empty array
  </instructions>
  <resume-signal>Type "configured" when .env.local is set and API returns data</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. All 5 route files exist in src/app/api/madplan/
3. curl to /api/madplan/ejere returns JSON (after env configured)
4. curl to /api/madplan/uge?ejerId=X&aar=2026&uge=4 returns ugeplan data
5. Network tab shows /api/madplan/* calls, NOT direct n8n URLs
</verification>

<success_criteria>
- .env.local.example documents required env var
- 5 API routes created: ejere, uge, dag, opskrifter, indkob
- All routes handle errors gracefully (500 for missing env, 400 for missing params)
- n8n URL is server-only (check browser source - no N8N_WEBHOOK_URL)
- Routes tested and returning data
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-data-flow/02-02-SUMMARY.md`
</output>
