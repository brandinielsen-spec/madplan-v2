---
phase: 02-core-data-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - madplan-v2/package.json
  - madplan-v2/src/lib/types.ts
  - madplan-v2/src/lib/week-utils.ts
  - madplan-v2/src/providers/swr-provider.tsx
  - madplan-v2/src/app/layout.tsx
  - madplan-v2/src/components/ui/checkbox.tsx
  - madplan-v2/src/components/ui/input.tsx
  - madplan-v2/src/components/ui/scroll-area.tsx
  - madplan-v2/src/components/ui/toggle-group.tsx
  - madplan-v2/src/components/ui/drawer.tsx
  - madplan-v2/src/components/ui/command.tsx
  - madplan-v2/src/components/ui/sonner.tsx
autonomous: true

must_haves:
  truths:
    - "SWR fetcher is available globally via provider"
    - "TypeScript types match v1 n8n workflow response shapes"
    - "ISO week calculation handles year boundaries correctly"
  artifacts:
    - path: "madplan-v2/src/lib/types.ts"
      provides: "TypeScript interfaces for Ejer, Opskrift, Ugeplan, DagEntry, Indkoebspost"
      exports: ["Ejer", "Opskrift", "Ugeplan", "DagEntry", "Indkoebspost", "ApiResponse"]
    - path: "madplan-v2/src/lib/week-utils.ts"
      provides: "ISO week calculation utilities"
      exports: ["getCurrentWeek", "navigateWeek", "getDateFromISOWeek", "getWeekDates", "formatDayDate"]
    - path: "madplan-v2/src/providers/swr-provider.tsx"
      provides: "Global SWR configuration"
      contains: "SWRConfig"
  key_links:
    - from: "madplan-v2/src/app/layout.tsx"
      to: "madplan-v2/src/providers/swr-provider.tsx"
      via: "SWRProvider wrapper in body"
      pattern: "SWRProvider"
---

<objective>
Install data layer dependencies and create foundation utilities for Phase 2.

Purpose: Establish the shared infrastructure (types, SWR config, date utilities, UI components) that all subsequent plans depend on.

Output: Working SWR provider, TypeScript types matching n8n responses, ISO week utilities, and additional shadcn/ui components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-data-flow/02-RESEARCH.md

# v1 workflow reference (response shapes)
@Madplan ver 1/README.md

# Existing layout to wrap with SWRProvider
@madplan-v2/src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add shadcn components</name>
  <files>madplan-v2/package.json</files>
  <action>
Install data layer dependencies:
```bash
cd madplan-v2 && npm install swr date-fns use-long-press
```

Add required shadcn/ui components:
```bash
npx shadcn@latest add sonner checkbox input scroll-area toggle-group drawer command
```

These components are needed for:
- sonner: Toast notifications for errors/success
- checkbox: Shopping list item toggle
- input: Recipe search, manual item add
- scroll-area: Recipe picker scrolling
- toggle-group: Cards/list view toggle
- drawer: Mobile-friendly recipe picker (Vaul-based)
- command: Recipe search with keyboard navigation
  </action>
  <verify>
Run `npm ls swr date-fns use-long-press` to confirm installation.
Check that all component files exist in src/components/ui/.
  </verify>
  <done>
SWR, date-fns, use-long-press installed. Seven new shadcn components added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types and utilities</name>
  <files>madplan-v2/src/lib/types.ts, madplan-v2/src/lib/week-utils.ts</files>
  <action>
Create `src/lib/types.ts` with interfaces matching v1 n8n response shapes:

```typescript
// API wrapper response
export interface ApiResponse<T> {
  success: boolean
  data: T
  error?: string
}

// Ejer (owner/user context)
export interface Ejer {
  id: string
  navn: string
}

// Opskrift (recipe)
export interface Opskrift {
  id: string
  ejerId: string
  titel: string
  portioner: number
  ingredienser: string[]  // Array of ingredient strings
  fremgangsmaade: string
  oprettetDato: string    // ISO date string
}

// Day entry in week plan
export interface DagEntry {
  ret: string | null
  opskriftId?: string
}

// Ugeplan (week plan)
export interface Ugeplan {
  id: string
  ejerId: string
  aar: number
  uge: number
  dage: {
    mandag: DagEntry
    tirsdag: DagEntry
    onsdag: DagEntry
    torsdag: DagEntry
    fredag: DagEntry
    loerdag: DagEntry
    soendag: DagEntry
  }
}

// Shopping list item
export interface Indkoebspost {
  id: string
  ejerId: string
  aar: number
  uge: number
  navn: string
  kilde: 'ret' | 'manuel'
  afkrydset: boolean
}

// Day names in Danish (for iteration)
export const DAGE = ['mandag', 'tirsdag', 'onsdag', 'torsdag', 'fredag', 'loerdag', 'soendag'] as const
export type DagNavn = typeof DAGE[number]
```

Create `src/lib/week-utils.ts` with ISO week utilities:

```typescript
import { getISOWeek, getISOWeekYear, startOfISOWeek, addWeeks, subWeeks, format } from 'date-fns'
import { da } from 'date-fns/locale'

export function getCurrentWeek(): { aar: number; uge: number } {
  const now = new Date()
  return {
    aar: getISOWeekYear(now),  // IMPORTANT: Use getISOWeekYear, not getYear
    uge: getISOWeek(now),
  }
}

export function navigateWeek(
  aar: number,
  uge: number,
  direction: 'prev' | 'next'
): { aar: number; uge: number } {
  const date = getDateFromISOWeek(aar, uge)
  const newDate = direction === 'next' ? addWeeks(date, 1) : subWeeks(date, 1)

  return {
    aar: getISOWeekYear(newDate),
    uge: getISOWeek(newDate),
  }
}

export function getDateFromISOWeek(year: number, week: number): Date {
  // January 4th is always in week 1 per ISO 8601
  const jan4 = new Date(year, 0, 4)
  const startOfWeek1 = startOfISOWeek(jan4)
  return addWeeks(startOfWeek1, week - 1)
}

export function getWeekDates(aar: number, uge: number): Date[] {
  const weekStart = getDateFromISOWeek(aar, uge)
  return Array.from({ length: 7 }, (_, i) => {
    const date = new Date(weekStart)
    date.setDate(weekStart.getDate() + i)
    return date
  })
}

export function formatDayDate(date: Date): string {
  return format(date, 'd. MMM', { locale: da })
}

export function formatWeekLabel(aar: number, uge: number): string {
  return `Uge ${uge}, ${aar}`
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles without errors.
Import test: Create a temporary test file that imports types and utilities.
  </verify>
  <done>
types.ts exports all interfaces. week-utils.ts exports all date functions. No TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SWR provider and wire into layout</name>
  <files>madplan-v2/src/providers/swr-provider.tsx, madplan-v2/src/app/layout.tsx</files>
  <action>
Create `src/providers/swr-provider.tsx`:

```typescript
'use client'

import { SWRConfig } from 'swr'
import { ReactNode } from 'react'
import { Toaster } from '@/components/ui/sonner'

const fetcher = async (url: string) => {
  const res = await fetch(url)
  if (!res.ok) {
    const error = new Error('Fetch failed')
    throw error
  }
  return res.json()
}

export function SWRProvider({ children }: { children: ReactNode }) {
  return (
    <SWRConfig
      value={{
        fetcher,
        revalidateOnFocus: false,
        shouldRetryOnError: false,
        dedupingInterval: 5000,
      }}
    >
      {children}
      <Toaster position="top-center" richColors />
    </SWRConfig>
  )
}
```

Update `src/app/layout.tsx` to wrap children with SWRProvider:

1. Import SWRProvider from '@/providers/swr-provider'
2. Wrap the body children with <SWRProvider>...</SWRProvider>
3. Keep existing font configuration and metadata

The Toaster is included in SWRProvider so all pages have access to toast() for error handling.
  </action>
  <verify>
Run `npm run dev` and check browser console for errors.
Visit any page - no errors should appear.
Toaster should be present in DOM (inspect body).
  </verify>
  <done>
SWRProvider wraps app. Toaster is available globally. No console errors on any page.
  </done>
</task>

</tasks>

<verification>
1. `npm ls swr date-fns use-long-press` shows all packages installed
2. `ls src/components/ui/` shows checkbox, input, scroll-area, toggle-group, drawer, command, sonner
3. `npx tsc --noEmit` passes without errors
4. `npm run dev` starts without errors
5. Browser console shows no errors when visiting pages
</verification>

<success_criteria>
- SWR, date-fns, use-long-press installed
- 7 new shadcn/ui components added
- types.ts exports: Ejer, Opskrift, Ugeplan, DagEntry, Indkoebspost, ApiResponse, DAGE, DagNavn
- week-utils.ts exports: getCurrentWeek, navigateWeek, getDateFromISOWeek, getWeekDates, formatDayDate, formatWeekLabel
- SWRProvider wraps app with global fetcher and Toaster
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-data-flow/02-01-SUMMARY.md`
</output>
