---
phase: 02-core-data-flow
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - madplan-v2/src/components/ugeplan/week-nav.tsx
  - madplan-v2/src/components/ugeplan/day-card.tsx
  - madplan-v2/src/components/ugeplan/recipe-picker.tsx
  - madplan-v2/src/app/ugeplan/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can see current week's meal plan"
    - "User can navigate between weeks with prev/next buttons"
    - "User can add a meal to a day via drawer picker"
    - "User can delete a meal from a day"
  artifacts:
    - path: "madplan-v2/src/components/ugeplan/week-nav.tsx"
      provides: "Week navigation component with prev/next and week label"
      exports: ["WeekNav"]
    - path: "madplan-v2/src/components/ugeplan/day-card.tsx"
      provides: "Day card showing meal with add/delete actions"
      exports: ["DayCard"]
    - path: "madplan-v2/src/components/ugeplan/recipe-picker.tsx"
      provides: "Drawer-based recipe picker with recent and all recipes"
      exports: ["RecipePicker"]
    - path: "madplan-v2/src/app/ugeplan/page.tsx"
      provides: "Week plan page with data fetching"
      contains: "useUgeplan"
  key_links:
    - from: "madplan-v2/src/app/ugeplan/page.tsx"
      to: "madplan-v2/src/hooks/use-ugeplan.ts"
      via: "useUgeplan hook import"
      pattern: "useUgeplan"
    - from: "madplan-v2/src/components/ugeplan/day-card.tsx"
      to: "madplan-v2/src/components/ugeplan/recipe-picker.tsx"
      via: "RecipePicker trigger on add button"
      pattern: "RecipePicker"
---

<objective>
Build the weekly meal plan view with navigation and meal management.

Purpose: This is the core feature - users can see their week, navigate between weeks, and add/edit/delete meals per day.

Output: Week navigation component, day cards with meal display, recipe picker drawer, and wired ugeplan page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-data-flow/02-CONTEXT.md
@.planning/phases/02-core-data-flow/02-RESEARCH.md
@.planning/phases/02-core-data-flow/02-01-SUMMARY.md
@.planning/phases/02-core-data-flow/02-02-SUMMARY.md
@.planning/phases/02-core-data-flow/02-03-SUMMARY.md

# Types and utilities
@madplan-v2/src/lib/types.ts
@madplan-v2/src/lib/week-utils.ts

# SWR hooks
@madplan-v2/src/hooks/use-ugeplan.ts
@madplan-v2/src/hooks/use-opskrifter.ts
@madplan-v2/src/hooks/use-ejere.ts

# Existing placeholder page
@madplan-v2/src/app/ugeplan/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create week navigation and day card components</name>
  <files>
    madplan-v2/src/components/ugeplan/week-nav.tsx
    madplan-v2/src/components/ugeplan/day-card.tsx
  </files>
  <action>
Create components directory: `src/components/ugeplan/`

Create `src/components/ugeplan/week-nav.tsx`:

```typescript
'use client'

import { Button } from '@/components/ui/button'
import { ChevronLeft, ChevronRight } from 'lucide-react'
import { formatWeekLabel } from '@/lib/week-utils'

interface WeekNavProps {
  aar: number
  uge: number
  onPrev: () => void
  onNext: () => void
  isLoading?: boolean
}

export function WeekNav({ aar, uge, onPrev, onNext, isLoading }: WeekNavProps) {
  return (
    <div className="flex items-center justify-between py-4">
      <Button
        variant="ghost"
        size="icon"
        onClick={onPrev}
        disabled={isLoading}
        aria-label="Forrige uge"
      >
        <ChevronLeft className="h-5 w-5" />
      </Button>

      <h2 className="text-lg font-heading font-semibold">
        {formatWeekLabel(aar, uge)}
      </h2>

      <Button
        variant="ghost"
        size="icon"
        onClick={onNext}
        disabled={isLoading}
        aria-label="Naeste uge"
      >
        <ChevronRight className="h-5 w-5" />
      </Button>
    </div>
  )
}
```

Create `src/components/ugeplan/day-card.tsx`:

```typescript
'use client'

import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Plus, X } from 'lucide-react'
import type { DagEntry, DagNavn } from '@/lib/types'
import { cn } from '@/lib/utils'

// Danish day names for display
const DAG_LABELS: Record<DagNavn, string> = {
  mandag: 'Mandag',
  tirsdag: 'Tirsdag',
  onsdag: 'Onsdag',
  torsdag: 'Torsdag',
  fredag: 'Fredag',
  loerdag: 'Lordag',
  soendag: 'Sondag',
}

interface DayCardProps {
  dag: DagNavn
  dato: string          // Formatted date string e.g. "24. jan"
  entry: DagEntry | null
  onAdd: () => void     // Opens recipe picker
  onDelete: () => void
  isToday?: boolean
  isMutating?: boolean
}

export function DayCard({
  dag,
  dato,
  entry,
  onAdd,
  onDelete,
  isToday = false,
  isMutating = false,
}: DayCardProps) {
  const hasRet = entry?.ret && entry.ret.trim() !== ''

  return (
    <Card className={cn(
      'transition-opacity',
      isToday && 'ring-2 ring-terracotta-500 ring-offset-2',
      isMutating && 'opacity-50'
    )}>
      <CardContent className="p-4">
        <div className="flex items-start justify-between gap-2">
          <div className="flex-1 min-w-0">
            <div className="flex items-baseline gap-2 mb-1">
              <span className="font-medium text-foreground">
                {DAG_LABELS[dag]}
              </span>
              <span className="text-sm text-muted-foreground">
                {dato}
              </span>
            </div>

            {hasRet ? (
              <p className="text-base text-foreground truncate">
                {entry.ret}
              </p>
            ) : (
              <p className="text-sm text-muted-foreground italic">
                Ingen ret planlagt
              </p>
            )}
          </div>

          <div className="flex items-center gap-1">
            {hasRet ? (
              <Button
                variant="ghost"
                size="icon"
                onClick={onDelete}
                disabled={isMutating}
                aria-label={`Fjern ${entry.ret} fra ${DAG_LABELS[dag]}`}
                className="h-8 w-8 text-muted-foreground hover:text-destructive"
              >
                <X className="h-4 w-4" />
              </Button>
            ) : null}

            <Button
              variant="ghost"
              size="icon"
              onClick={onAdd}
              disabled={isMutating}
              aria-label={`Tilfoej ret til ${DAG_LABELS[dag]}`}
              className="h-8 w-8"
            >
              <Plus className="h-4 w-4" />
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  )
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify components compile.
Check that DayCard handles null entry gracefully.
  </verify>
  <done>
WeekNav and DayCard components created with proper typing and accessibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create recipe picker drawer</name>
  <files>madplan-v2/src/components/ugeplan/recipe-picker.tsx</files>
  <action>
Create `src/components/ugeplan/recipe-picker.tsx`:

```typescript
'use client'

import { useState } from 'react'
import {
  Drawer,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerTitle,
  DrawerTrigger,
} from '@/components/ui/drawer'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { ScrollArea } from '@/components/ui/scroll-area'
import { Search } from 'lucide-react'
import type { Opskrift } from '@/lib/types'

interface RecipePickerProps {
  opskrifter: Opskrift[]
  recentRetter: string[]        // Recently used meal names
  onSelect: (ret: string, opskriftId?: string) => void
  trigger: React.ReactNode
  open?: boolean
  onOpenChange?: (open: boolean) => void
}

export function RecipePicker({
  opskrifter,
  recentRetter,
  onSelect,
  trigger,
  open,
  onOpenChange,
}: RecipePickerProps) {
  const [search, setSearch] = useState('')

  const filteredOpskrifter = opskrifter.filter((o) =>
    o.titel.toLowerCase().includes(search.toLowerCase())
  )

  // Filter recent that aren't in current search
  const filteredRecent = recentRetter.filter((r) =>
    r.toLowerCase().includes(search.toLowerCase())
  )

  const handleSelect = (ret: string, opskriftId?: string) => {
    onSelect(ret, opskriftId)
    setSearch('')  // Reset search on select
  }

  return (
    <Drawer open={open} onOpenChange={onOpenChange}>
      <DrawerTrigger asChild>
        {trigger}
      </DrawerTrigger>
      <DrawerContent>
        <DrawerHeader>
          <DrawerTitle>Vaelg ret</DrawerTitle>
        </DrawerHeader>

        <div className="px-4 pb-2">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Soeg i opskrifter..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-9"
            />
          </div>
        </div>

        <ScrollArea className="h-[50vh] px-4">
          {/* Recent meals section */}
          {filteredRecent.length > 0 && !search && (
            <div className="mb-6">
              <h3 className="text-sm font-medium text-muted-foreground mb-2">
                Senest brugte
              </h3>
              <div className="space-y-1">
                {filteredRecent.slice(0, 5).map((ret) => (
                  <DrawerClose key={ret} asChild>
                    <Button
                      variant="ghost"
                      className="w-full justify-start h-auto py-2 px-3"
                      onClick={() => handleSelect(ret)}
                    >
                      {ret}
                    </Button>
                  </DrawerClose>
                ))}
              </div>
            </div>
          )}

          {/* All recipes section */}
          <div>
            <h3 className="text-sm font-medium text-muted-foreground mb-2">
              {search ? 'Resultater' : 'Alle opskrifter'}
            </h3>
            {filteredOpskrifter.length === 0 ? (
              <p className="text-sm text-muted-foreground py-4 text-center">
                {search ? 'Ingen opskrifter matcher' : 'Ingen opskrifter endnu'}
              </p>
            ) : (
              <div className="space-y-1">
                {filteredOpskrifter.map((opskrift) => (
                  <DrawerClose key={opskrift.id} asChild>
                    <Button
                      variant="ghost"
                      className="w-full justify-start h-auto py-2 px-3"
                      onClick={() => handleSelect(opskrift.titel, opskrift.id)}
                    >
                      {opskrift.titel}
                    </Button>
                  </DrawerClose>
                ))}
              </div>
            )}
          </div>

          {/* Quick add custom meal */}
          {search && !filteredOpskrifter.some(o => o.titel.toLowerCase() === search.toLowerCase()) && (
            <div className="mt-4 pt-4 border-t">
              <DrawerClose asChild>
                <Button
                  variant="outline"
                  className="w-full"
                  onClick={() => handleSelect(search)}
                >
                  Tilfoej "{search}" som ret
                </Button>
              </DrawerClose>
            </div>
          )}
        </ScrollArea>
      </DrawerContent>
    </Drawer>
  )
}
```

Features:
- Search input filters both recent and all recipes
- Recent meals shown first (when not searching)
- Quick add allows typing a custom meal name
- DrawerClose wraps buttons to auto-close on select
- Controlled via open/onOpenChange for external control
  </action>
  <verify>
Run `npx tsc --noEmit` to verify component compiles.
  </verify>
  <done>
RecipePicker drawer created with search, recent meals, and quick add functionality.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire ugeplan page with data and components</name>
  <files>madplan-v2/src/app/ugeplan/page.tsx</files>
  <action>
Replace the placeholder ugeplan/page.tsx with the fully wired version:

```typescript
'use client'

import { useState, useMemo } from 'react'
import { toast } from 'sonner'
import { AppShell } from '@/components/layout/app-shell'
import { WeekNav } from '@/components/ugeplan/week-nav'
import { DayCard } from '@/components/ugeplan/day-card'
import { RecipePicker } from '@/components/ugeplan/recipe-picker'
import { Skeleton } from '@/components/ui/skeleton'
import { useUgeplan } from '@/hooks/use-ugeplan'
import { useOpskrifter } from '@/hooks/use-opskrifter'
import { useEjere } from '@/hooks/use-ejere'
import { getCurrentWeek, navigateWeek, getWeekDates, formatDayDate } from '@/lib/week-utils'
import { DAGE, type DagNavn } from '@/lib/types'
import { getISOWeek, getISOWeekYear } from 'date-fns'

export default function UgeplanPage() {
  // Week state - start with current week
  const [week, setWeek] = useState(getCurrentWeek)

  // Selected day for recipe picker
  const [selectedDag, setSelectedDag] = useState<DagNavn | null>(null)

  // TODO: In a real app, ejerId would come from user selection/context
  // For now, use first ejer or null
  const { ejere, isLoading: ejereLoading } = useEjere()
  const ejerId = ejere[0]?.id ?? null

  // Data hooks
  const {
    ugeplan,
    isLoading: ugeplanLoading,
    isError: ugeplanError,
    updateDay,
    deleteDay,
    isMutating,
  } = useUgeplan(ejerId, week.aar, week.uge)

  const { opskrifter } = useOpskrifter(ejerId)

  // Calculate dates for the week
  const weekDates = useMemo(() => getWeekDates(week.aar, week.uge), [week.aar, week.uge])

  // Check if a date is today
  const today = new Date()
  const todayWeek = getISOWeek(today)
  const todayYear = getISOWeekYear(today)
  const todayDayIndex = (today.getDay() + 6) % 7  // Convert Sunday=0 to Monday=0

  // Extract recent meals from current ugeplan
  const recentRetter = useMemo(() => {
    if (!ugeplan?.dage) return []
    return Object.values(ugeplan.dage)
      .map((entry) => entry?.ret)
      .filter((ret): ret is string => !!ret && ret.trim() !== '')
  }, [ugeplan])

  // Handlers
  const handlePrevWeek = () => {
    setWeek(navigateWeek(week.aar, week.uge, 'prev'))
  }

  const handleNextWeek = () => {
    setWeek(navigateWeek(week.aar, week.uge, 'next'))
  }

  const handleAddMeal = (dag: DagNavn) => {
    setSelectedDag(dag)
  }

  const handleSelectMeal = async (ret: string, opskriftId?: string) => {
    if (!selectedDag) return
    try {
      await updateDay(selectedDag, ret, opskriftId)
      toast.success(`${ret} tilfojet`)
    } catch (error) {
      toast.error('Kunne ikke tilfoeje ret')
    } finally {
      setSelectedDag(null)
    }
  }

  const handleDeleteMeal = async (dag: DagNavn) => {
    try {
      await deleteDay(dag)
      toast.success('Ret fjernet')
    } catch (error) {
      toast.error('Kunne ikke fjerne ret')
    }
  }

  const isLoading = ejereLoading || ugeplanLoading

  return (
    <AppShell title="Ugeplan">
      <WeekNav
        aar={week.aar}
        uge={week.uge}
        onPrev={handlePrevWeek}
        onNext={handleNextWeek}
        isLoading={isLoading}
      />

      {isLoading ? (
        <div className="space-y-3">
          {Array.from({ length: 7 }).map((_, i) => (
            <Skeleton key={i} className="h-20 w-full" />
          ))}
        </div>
      ) : ugeplanError ? (
        <div className="text-center py-8 text-muted-foreground">
          <p>Kunne ikke hente ugeplan</p>
          <p className="text-sm mt-1">Tjek din forbindelse og proev igen</p>
        </div>
      ) : (
        <div className="space-y-3 pb-4">
          {DAGE.map((dag, index) => {
            const isToday =
              week.aar === todayYear &&
              week.uge === todayWeek &&
              index === todayDayIndex

            return (
              <DayCard
                key={dag}
                dag={dag}
                dato={formatDayDate(weekDates[index])}
                entry={ugeplan?.dage?.[dag] ?? null}
                onAdd={() => handleAddMeal(dag)}
                onDelete={() => handleDeleteMeal(dag)}
                isToday={isToday}
                isMutating={isMutating}
              />
            )
          })}
        </div>
      )}

      {/* Recipe picker drawer - controlled by selectedDag */}
      <RecipePicker
        opskrifter={opskrifter}
        recentRetter={recentRetter}
        onSelect={handleSelectMeal}
        open={selectedDag !== null}
        onOpenChange={(open) => !open && setSelectedDag(null)}
        trigger={<span />}  // Hidden trigger, opened programmatically
      />
    </AppShell>
  )
}
```

Key implementation details:
- Uses URL params for future shareable links (can add later)
- For now, uses first ejer from list (owner selection deferred)
- Today's card highlighted with ring
- Loading skeletons match card layout
- Error state shows friendly message
- RecipePicker controlled by selectedDag state
- Toast notifications for success/error
  </action>
  <verify>
Run `npm run dev` and navigate to /ugeplan.
Check that week navigation works.
Check that loading states show skeletons.
  </verify>
  <done>
Ugeplan page fully wired with WeekNav, DayCards, RecipePicker, and data hooks.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify ugeplan functionality</name>
  <what-built>
Complete week plan view with:
- Week navigation (prev/next)
- Day cards showing meals
- Recipe picker drawer
- Add/delete meal functionality
- Loading and error states
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to http://localhost:3000/ugeplan
3. Check week navigation:
   - Current week shows with today highlighted
   - Click prev/next arrows to navigate weeks
   - Week label updates (e.g., "Uge 4, 2026")
4. Check add meal flow:
   - Click + button on any day
   - Recipe picker drawer opens from bottom
   - Search filters recipes
   - Selecting a recipe/typing custom name adds it
   - Toast shows success
5. Check delete meal flow:
   - Click X on a day with a meal
   - Meal is removed
   - Toast shows success
6. Check error handling:
   - Disconnect network or stop n8n
   - Navigate weeks - error message shows
  </how-to-verify>
  <resume-signal>Type "approved" if ugeplan works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Components exist in src/components/ugeplan/
3. /ugeplan page loads without console errors
4. Week navigation changes displayed week
5. Add meal opens drawer and saves
6. Delete meal removes the entry
7. Toast notifications appear
</verification>

<success_criteria>
- WeekNav component with prev/next navigation
- DayCard component with meal display and add/delete
- RecipePicker drawer with search and quick add
- Ugeplan page wired with hooks and state
- User can complete full add/delete workflow
- No console errors in browser
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-data-flow/02-04-SUMMARY.md`
</output>
