---
phase: 05-organization
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - madplan-v2/src/components/opskrifter/filter-bar.tsx
  - madplan-v2/src/components/opskrifter/empty-state.tsx
  - madplan-v2/src/app/opskrifter/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see tag filter chips below search"
    - "User can tap tag chip to filter by that tag"
    - "User can tap heart chip to show only favorites"
    - "Multiple tag filters use AND logic"
    - "Search + tags + favorites filters work together"
    - "Empty state shows when no recipes match filters"
  artifacts:
    - path: "madplan-v2/src/components/opskrifter/filter-bar.tsx"
      provides: "Horizontal scrollable filter row"
      exports: ["FilterBar"]
      min_lines: 60
    - path: "madplan-v2/src/components/opskrifter/empty-state.tsx"
      provides: "No results message component"
      exports: ["EmptyState"]
      min_lines: 15
    - path: "madplan-v2/src/app/opskrifter/page.tsx"
      provides: "Complete filtering with favorites toggle"
      contains: "FilterBar"
  key_links:
    - from: "madplan-v2/src/app/opskrifter/page.tsx"
      to: "madplan-v2/src/components/opskrifter/filter-bar.tsx"
      via: "component import"
      pattern: "import.*FilterBar"
    - from: "madplan-v2/src/app/opskrifter/page.tsx"
      to: "useMemo filtering"
      via: "client-side filter logic"
      pattern: "selectedTags\\.every"
---

<objective>
Implement filter bar with tag chips and favorites toggle for the Opskrifter page.

Purpose: Enable users to filter recipes by tags (ORG-04) and favorites (ORG-05), combined with existing search (ORG-03).
Output: FilterBar component, EmptyState component, complete filtering in Opskrifter page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-organization/05-CONTEXT.md
@.planning/phases/05-organization/05-RESEARCH.md
@.planning/phases/05-organization/05-02-SUMMARY.md
@.planning/phases/05-organization/05-03-SUMMARY.md

# File to modify
@madplan-v2/src/app/opskrifter/page.tsx

# Components to reference
@madplan-v2/src/components/opskrifter/tag-chip.tsx
@madplan-v2/src/components/opskrifter/recipe-card.tsx
@madplan-v2/src/components/opskrifter/recipe-list-item.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FilterBar and EmptyState components</name>
  <files>madplan-v2/src/components/opskrifter/filter-bar.tsx, madplan-v2/src/components/opskrifter/empty-state.tsx</files>
  <action>
1. Create `filter-bar.tsx`:
   - Horizontal scrollable row of filter chips
   - Heart chip first for favorites filter
   - Tag chips after, using all available tags
   - Selected chips have filled style, unselected have outline
   - Multi-select: clicking adds/removes from selectedTags

   ```typescript
   'use client'

   import { Heart } from 'lucide-react'
   import { Badge } from '@/components/ui/badge'
   import { ScrollArea, ScrollBar } from '@/components/ui/scroll-area'
   import { cn } from '@/lib/utils'

   interface FilterBarProps {
     allTags: string[]
     selectedTags: string[]
     onTagToggle: (tag: string) => void
     showFavoritesOnly: boolean
     onFavoritesToggle: () => void
   }

   export function FilterBar({
     allTags,
     selectedTags,
     onTagToggle,
     showFavoritesOnly,
     onFavoritesToggle,
   }: FilterBarProps) {
     if (allTags.length === 0 && !showFavoritesOnly) {
       return null // No filters to show
     }

     return (
       <ScrollArea className="w-full whitespace-nowrap">
         <div className="flex gap-2 pb-2">
           {/* Favorites filter chip */}
           <button
             onClick={onFavoritesToggle}
             className={cn(
               "inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-medium transition-colors",
               "border focus:outline-none focus-visible:ring-2 focus-visible:ring-terracotta-400",
               showFavoritesOnly
                 ? "bg-terracotta-100 text-terracotta-700 border-terracotta-300"
                 : "bg-background text-muted-foreground border-input hover:bg-sand-100"
             )}
           >
             <Heart
               className={cn(
                 "h-3.5 w-3.5",
                 showFavoritesOnly && "fill-terracotta-500 text-terracotta-500"
               )}
             />
             Favoritter
           </button>

           {/* Tag filter chips */}
           {allTags.map((tag) => {
             const isSelected = selectedTags.includes(tag)
             return (
               <button
                 key={tag}
                 onClick={() => onTagToggle(tag)}
                 className={cn(
                   "px-3 py-1 rounded-full text-sm font-medium transition-colors",
                   "border focus:outline-none focus-visible:ring-2 focus-visible:ring-olive-400",
                   isSelected
                     ? "bg-olive-100 text-olive-700 border-olive-300"
                     : "bg-background text-muted-foreground border-input hover:bg-sand-100"
                 )}
               >
                 {tag}
               </button>
             )
           })}
         </div>
         <ScrollBar orientation="horizontal" />
       </ScrollArea>
     )
   }
   ```

2. Create `empty-state.tsx`:
   - Show different messages based on filter state
   - Clear filters suggestion when filters active

   ```typescript
   'use client'

   import { Card, CardContent } from '@/components/ui/card'
   import { Button } from '@/components/ui/button'

   interface EmptyStateProps {
     search: string
     hasTagFilters: boolean
     hasFavoriteFilter: boolean
     onClearFilters: () => void
   }

   export function EmptyState({
     search,
     hasTagFilters,
     hasFavoriteFilter,
     onClearFilters,
   }: EmptyStateProps) {
     const hasFilters = search.trim() || hasTagFilters || hasFavoriteFilter

     return (
       <Card>
         <CardContent className="py-8 text-center">
           {hasFilters ? (
             <>
               <p className="text-muted-foreground">
                 Ingen opskrifter matcher dine filtre
               </p>
               <Button
                 variant="link"
                 onClick={onClearFilters}
                 className="mt-2"
               >
                 Ryd alle filtre
               </Button>
             </>
           ) : (
             <>
               <p className="text-muted-foreground">Ingen opskrifter endnu</p>
               <p className="text-sm text-muted-foreground mt-1">
                 Tilfoej opskrifter fra Tilfoej-fanen
               </p>
             </>
           )}
         </CardContent>
       </Card>
     )
   }
   ```
  </action>
  <verify>
    - `grep -n "export.*FilterBar" madplan-v2/src/components/opskrifter/filter-bar.tsx` shows export
    - `grep -n "export.*EmptyState" madplan-v2/src/components/opskrifter/empty-state.tsx` shows export
    - TypeScript compiles: `cd madplan-v2 && npx tsc --noEmit`
  </verify>
  <done>FilterBar and EmptyState components created</done>
</task>

<task type="auto">
  <name>Task 2: Integrate filtering into Opskrifter page</name>
  <files>madplan-v2/src/app/opskrifter/page.tsx</files>
  <action>
Update `opskrifter/page.tsx` with complete filtering:

1. Add filter state:
   ```typescript
   const [selectedTags, setSelectedTags] = useState<string[]>([])
   const [showFavoritesOnly, setShowFavoritesOnly] = useState(false)
   ```

2. Update useOpskrifter usage to get allTags and toggleFavorite:
   ```typescript
   const {
     opskrifter,
     isLoading: opskrifterLoading,
     isError,
     allTags,
     toggleFavorite,
   } = useOpskrifter(ejerId)
   ```

3. Update filteredOpskrifter useMemo with all filter logic:
   ```typescript
   const filteredOpskrifter = useMemo(() => {
     let result = opskrifter

     // Search filter (title only)
     if (search.trim()) {
       const searchLower = search.toLowerCase()
       result = result.filter((o) =>
         o.titel.toLowerCase().includes(searchLower)
       )
     }

     // Tag filter (AND logic - must have ALL selected tags)
     if (selectedTags.length > 0) {
       result = result.filter((o) =>
         selectedTags.every((tag) => (o.tags ?? []).includes(tag))
       )
     }

     // Favorites filter
     if (showFavoritesOnly) {
       result = result.filter((o) => o.favorit === true)
     }

     return result
   }, [opskrifter, search, selectedTags, showFavoritesOnly])
   ```

4. Add filter handlers:
   ```typescript
   const handleTagToggle = (tag: string) => {
     setSelectedTags((prev) =>
       prev.includes(tag)
         ? prev.filter((t) => t !== tag)
         : [...prev, tag]
     )
   }

   const handleClearFilters = () => {
     setSearch('')
     setSelectedTags([])
     setShowFavoritesOnly(false)
   }
   ```

5. Add X button to search input when text present:
   - Add import for X icon from lucide-react
   - Show X button inside search input when search has value
   - Clicking X clears search

6. Add FilterBar below search/toggle row:
   ```typescript
   <FilterBar
     allTags={allTags}
     selectedTags={selectedTags}
     onTagToggle={handleTagToggle}
     showFavoritesOnly={showFavoritesOnly}
     onFavoritesToggle={() => setShowFavoritesOnly((prev) => !prev)}
   />
   ```

7. Update RecipeCard/RecipeListItem to pass onToggleFavorite:
   ```typescript
   <RecipeCard
     key={recipe.id}
     recipe={recipe}
     onToggleFavorite={() => toggleFavorite(recipe.id)}
   />
   ```

8. Replace empty state with EmptyState component:
   ```typescript
   <EmptyState
     search={search}
     hasTagFilters={selectedTags.length > 0}
     hasFavoriteFilter={showFavoritesOnly}
     onClearFilters={handleClearFilters}
   />
   ```

Full integration ensures:
- Search filters by title (existing, extended with clear button)
- Tag filters with AND logic
- Favorites filter
- All filters combine (AND across filter types)
- Empty state offers to clear filters
- Favorite toggle works from cards and list items
  </action>
  <verify>
    - `grep -n "FilterBar" madplan-v2/src/app/opskrifter/page.tsx` shows import and usage
    - `grep -n "selectedTags" madplan-v2/src/app/opskrifter/page.tsx` shows state and filter logic
    - `grep -n "showFavoritesOnly" madplan-v2/src/app/opskrifter/page.tsx` shows state and filter logic
    - `grep -n "toggleFavorite" madplan-v2/src/app/opskrifter/page.tsx` shows it's passed to cards
    - Dev server runs and page works: `npm run dev`
  </verify>
  <done>Complete filtering integrated into Opskrifter page</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd madplan-v2 && npm run build` passes
2. Components created:
   - `grep "export.*FilterBar" src/components/opskrifter/filter-bar.tsx`
   - `grep "export.*EmptyState" src/components/opskrifter/empty-state.tsx`
3. Page integration:
   - `grep "FilterBar" src/app/opskrifter/page.tsx`
   - `grep "selectedTags.every" src/app/opskrifter/page.tsx`
   - `grep "onToggleFavorite" src/app/opskrifter/page.tsx`
</verification>

<success_criteria>
- FilterBar shows below search with favorites chip first, then tag chips
- Tapping favorites chip toggles "favorites only" mode
- Tapping tag chip toggles that tag in filter
- Multiple tags selected = show recipes with ALL those tags (AND logic)
- Search + tags + favorites all filter together
- Clear button in search clears search text
- EmptyState shows "no match" message with clear filters button when filters active
- EmptyState shows "no recipes" message when no filters and empty
- Favorite button works on recipe cards in grid view
- Favorite button works on recipe list items
</success_criteria>

<output>
After completion, create `.planning/phases/05-organization/05-04-SUMMARY.md`
</output>
