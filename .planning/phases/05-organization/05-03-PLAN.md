---
phase: 05-organization
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - madplan-v2/src/components/opskrifter/tag-chip.tsx
  - madplan-v2/src/components/opskrifter/tag-input.tsx
  - madplan-v2/src/hooks/use-opskrifter.ts
  - madplan-v2/src/app/opskrifter/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see existing tags on recipe detail page"
    - "User can add new tags via autocomplete input"
    - "User can remove tags by clicking X on chips"
    - "Tag changes persist to backend"
    - "Existing tags appear as suggestions when typing"
  artifacts:
    - path: "madplan-v2/src/components/opskrifter/tag-chip.tsx"
      provides: "Tag display chip with optional remove button"
      exports: ["TagChip"]
      min_lines: 20
    - path: "madplan-v2/src/components/opskrifter/tag-input.tsx"
      provides: "Autocomplete combobox for adding tags"
      exports: ["TagInput"]
      min_lines: 50
    - path: "madplan-v2/src/hooks/use-opskrifter.ts"
      provides: "updateTags function, allTags computed"
      contains: "updateTags"
    - path: "madplan-v2/src/app/opskrifter/[id]/page.tsx"
      provides: "Tag management section with chips and input"
      contains: "TagInput"
  key_links:
    - from: "madplan-v2/src/components/opskrifter/tag-input.tsx"
      to: "madplan-v2/src/components/ui/popover.tsx"
      via: "Popover import"
      pattern: "import.*Popover"
    - from: "madplan-v2/src/components/opskrifter/tag-input.tsx"
      to: "madplan-v2/src/components/ui/command.tsx"
      via: "Command import"
      pattern: "import.*Command"
    - from: "madplan-v2/src/hooks/use-opskrifter.ts"
      to: "/api/madplan/opskrift/tags"
      via: "fetch POST"
      pattern: "api/madplan/opskrift/tags"
---

<objective>
Implement tag management for recipes with autocomplete input and chip display.

Purpose: Enable users to add and remove tags on recipes (ORG-02) with suggestions from existing tags.
Output: TagChip, TagInput components, extended hook with updateTags, detail page integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-organization/05-CONTEXT.md
@.planning/phases/05-organization/05-RESEARCH.md
@.planning/phases/05-organization/05-01-SUMMARY.md

# Files to modify
@madplan-v2/src/hooks/use-opskrifter.ts
@madplan-v2/src/app/opskrifter/[id]/page.tsx

# UI components to use
@madplan-v2/src/components/ui/popover.tsx
@madplan-v2/src/components/ui/command.tsx
@madplan-v2/src/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TagChip and TagInput components</name>
  <files>madplan-v2/src/components/opskrifter/tag-chip.tsx, madplan-v2/src/components/opskrifter/tag-input.tsx</files>
  <action>
1. Create `tag-chip.tsx`:
   - Display tag with optional X button for removal
   - Use Badge component with olive color from earth tone palette
   - Support two modes: display (no X) and editable (with X)

   ```typescript
   'use client'

   import { Badge } from '@/components/ui/badge'
   import { X } from 'lucide-react'
   import { cn } from '@/lib/utils'

   interface TagChipProps {
     tag: string
     onRemove?: () => void
     className?: string
   }

   export function TagChip({ tag, onRemove, className }: TagChipProps) {
     return (
       <Badge
         variant="secondary"
         className={cn(
           "bg-olive-100 text-olive-700 hover:bg-olive-200 border-olive-200",
           "transition-colors",
           className
         )}
       >
         {tag}
         {onRemove && (
           <button
             onClick={(e) => {
               e.preventDefault()
               e.stopPropagation()
               onRemove()
             }}
             className="ml-1 hover:text-olive-900 focus:outline-none"
             aria-label={`Fjern tag ${tag}`}
           >
             <X className="h-3 w-3" />
           </button>
         )}
       </Badge>
     )
   }
   ```

2. Create `tag-input.tsx`:
   - Combobox using Popover + Command from shadcn/ui
   - Shows suggestions from existingTags as user types
   - Allows creating new tags (shown in CommandEmpty)
   - Input clears after selection

   ```typescript
   'use client'

   import { useState } from 'react'
   import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover'
   import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from '@/components/ui/command'
   import { Button } from '@/components/ui/button'
   import { Plus } from 'lucide-react'
   import { cn } from '@/lib/utils'

   interface TagInputProps {
     existingTags: string[]
     currentTags: string[]
     onAddTag: (tag: string) => void
     className?: string
   }

   export function TagInput({ existingTags, currentTags, onAddTag, className }: TagInputProps) {
     const [open, setOpen] = useState(false)
     const [inputValue, setInputValue] = useState('')

     // Filter suggestions: existing tags not already on this recipe
     const suggestions = existingTags
       .filter((tag) => !currentTags.includes(tag))
       .filter((tag) => tag.toLowerCase().includes(inputValue.toLowerCase()))

     const handleSelect = (tag: string) => {
       onAddTag(tag)
       setInputValue('')
       setOpen(false)
     }

     const handleCreateNew = () => {
       const trimmed = inputValue.trim()
       if (trimmed && !currentTags.includes(trimmed)) {
         onAddTag(trimmed)
         setInputValue('')
         setOpen(false)
       }
     }

     return (
       <Popover open={open} onOpenChange={setOpen}>
         <PopoverTrigger asChild>
           <Button
             variant="outline"
             size="sm"
             className={cn("gap-1 text-muted-foreground", className)}
           >
             <Plus className="h-3 w-3" />
             Tilfoej tag
           </Button>
         </PopoverTrigger>
         <PopoverContent className="w-64 p-0" align="start">
           <Command shouldFilter={false}>
             <CommandInput
               placeholder="Soeg eller opret tag..."
               value={inputValue}
               onValueChange={setInputValue}
             />
             <CommandList>
               {suggestions.length === 0 && inputValue.trim() ? (
                 <CommandEmpty>
                   <button
                     onClick={handleCreateNew}
                     className="w-full px-2 py-1.5 text-left text-sm hover:bg-accent rounded"
                   >
                     Opret "{inputValue.trim()}"
                   </button>
                 </CommandEmpty>
               ) : suggestions.length === 0 ? (
                 <CommandEmpty>
                   <span className="text-muted-foreground text-sm">
                     Skriv for at oprette nyt tag
                   </span>
                 </CommandEmpty>
               ) : null}
               {suggestions.length > 0 && (
                 <CommandGroup>
                   {suggestions.slice(0, 10).map((tag) => (
                     <CommandItem
                       key={tag}
                       value={tag}
                       onSelect={() => handleSelect(tag)}
                     >
                       {tag}
                     </CommandItem>
                   ))}
                 </CommandGroup>
               )}
             </CommandList>
           </Command>
         </PopoverContent>
       </Popover>
     )
   }
   ```

Key decisions:
- shouldFilter={false} on Command because we filter manually to exclude current tags
- Limit suggestions to 10 to avoid overflow
- Button trigger instead of Input trigger for clearer UX
  </action>
  <verify>
    - `grep -n "export.*TagChip" madplan-v2/src/components/opskrifter/tag-chip.tsx` shows export
    - `grep -n "export.*TagInput" madplan-v2/src/components/opskrifter/tag-input.tsx` shows export
    - TypeScript compiles: `cd madplan-v2 && npx tsc --noEmit`
  </verify>
  <done>TagChip and TagInput components created</done>
</task>

<task type="auto">
  <name>Task 2: Extend hook and integrate into detail page</name>
  <files>madplan-v2/src/hooks/use-opskrifter.ts, madplan-v2/src/app/opskrifter/[id]/page.tsx</files>
  <action>
1. Extend `use-opskrifter.ts`:
   - Add allTags computed value (unique tags across all recipes)
   - Add updateTags function with optimistic update

   ```typescript
   import { useMemo } from 'react'
   // ... existing imports

   export function useOpskrifter(ejerId: string | null) {
     // ... existing code

     // Compute all unique tags across recipes
     const allTags = useMemo(() => {
       if (!data) return []
       const tagSet = new Set<string>()
       data.forEach((o) => {
         o.tags?.forEach((tag) => tagSet.add(tag))
       })
       return Array.from(tagSet).sort()
     }, [data])

     const updateTags = async (opskriftId: string, newTags: string[]) => {
       if (!cacheKey || !data) return

       // Optimistic update
       mutate(
         data.map((o) =>
           o.id === opskriftId ? { ...o, tags: newTags } : o
         ),
         {
           revalidate: false,
           rollbackOnError: true,
         }
       )

       // Server sync
       try {
         const response = await fetch('/api/madplan/opskrift/tags', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ opskriftId, tags: newTags }),
         })
         if (!response.ok) throw new Error('Failed to update tags')
       } catch (error) {
         console.error('Update tags error:', error)
         throw error
       }
     }

     return {
       opskrifter: data ?? [],
       isLoading,
       isError: !!error,
       error,
       mutate,
       toggleFavorite,
       allTags,
       updateTags,
     }
   }
   ```

2. Update `[id]/page.tsx`:
   - Add tag management section below source link, above delete button
   - Display current tags as TagChips with remove buttons
   - Add TagInput for adding new tags
   - Wire up add/remove handlers using updateTags

   ```typescript
   // Imports
   import { TagChip } from '@/components/opskrifter/tag-chip'
   import { TagInput } from '@/components/opskrifter/tag-input'

   // In component:
   const { opskrifter, toggleFavorite, allTags, updateTags } = useOpskrifter(ejerId)

   const handleAddTag = (tag: string) => {
     const currentTags = opskrift.tags ?? []
     if (!currentTags.includes(tag)) {
       updateTags(opskrift.id, [...currentTags, tag])
     }
   }

   const handleRemoveTag = (tag: string) => {
     const currentTags = opskrift.tags ?? []
     updateTags(opskrift.id, currentTags.filter((t) => t !== tag))
   }

   // In JSX, after source and before delete:
   {/* Tags section */}
   <div className="space-y-2">
     <h3 className="text-sm font-medium text-muted-foreground">Tags</h3>
     <div className="flex flex-wrap gap-2 items-center">
       {(opskrift.tags ?? []).map((tag) => (
         <TagChip
           key={tag}
           tag={tag}
           onRemove={() => handleRemoveTag(tag)}
         />
       ))}
       <TagInput
         existingTags={allTags}
         currentTags={opskrift.tags ?? []}
         onAddTag={handleAddTag}
       />
     </div>
   </div>
   ```
  </action>
  <verify>
    - `grep -n "allTags" madplan-v2/src/hooks/use-opskrifter.ts` shows computed value
    - `grep -n "updateTags" madplan-v2/src/hooks/use-opskrifter.ts` shows function
    - `grep -n "TagInput" madplan-v2/src/app/opskrifter/[id]/page.tsx` shows integration
    - Dev server runs: `npm run dev` works without errors
  </verify>
  <done>Hook extended with tag functions, detail page has tag management</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd madplan-v2 && npm run build` passes
2. Components exported:
   - `grep "export.*TagChip" src/components/opskrifter/tag-chip.tsx`
   - `grep "export.*TagInput" src/components/opskrifter/tag-input.tsx`
3. Hook extended:
   - `grep "allTags" src/hooks/use-opskrifter.ts`
   - `grep "updateTags" src/hooks/use-opskrifter.ts`
4. Detail page integrated:
   - `grep "TagChip\|TagInput" src/app/opskrifter/[id]/page.tsx`
</verification>

<success_criteria>
- TagChip displays tag with olive coloring
- TagChip shows X button when onRemove provided
- TagInput opens combobox with existing tag suggestions
- TagInput allows creating new tags by typing
- Recipe detail page shows current tags as chips
- Clicking X removes tag immediately (optimistic)
- Using TagInput adds tag immediately (optimistic)
- Tag changes persist to backend via API
</success_criteria>

<output>
After completion, create `.planning/phases/05-organization/05-03-SUMMARY.md`
</output>
