---
phase: 05-organization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - madplan-v2/src/lib/types.ts
  - madplan-v2/src/app/api/madplan/opskrift/favorit/route.ts
  - madplan-v2/src/app/api/madplan/opskrift/tags/route.ts
  - madplan-v2/src/app/globals.css
  - madplan-v2/src/components/ui/popover.tsx
autonomous: true
user_setup:
  - service: airtable
    why: "New fields for favorites and tags"
    dashboard_config:
      - task: "Add Favorit field (Checkbox) to Opskrifter table"
        location: "Airtable Base -> Opskrifter table -> Add field"
      - task: "Add Tags field (Multiple select) to Opskrifter table"
        location: "Airtable Base -> Opskrifter table -> Add field"

must_haves:
  truths:
    - "Types include favorit and tags fields"
    - "API can toggle favorite status"
    - "API can update tags array"
    - "Heart pulse animation is defined"
  artifacts:
    - path: "madplan-v2/src/lib/types.ts"
      provides: "Extended Opskrift type with favorit and tags"
      contains: "favorit?: boolean"
    - path: "madplan-v2/src/app/api/madplan/opskrift/favorit/route.ts"
      provides: "Favorite toggle endpoint"
      exports: ["POST"]
    - path: "madplan-v2/src/app/api/madplan/opskrift/tags/route.ts"
      provides: "Tags update endpoint"
      exports: ["POST"]
    - path: "madplan-v2/src/app/globals.css"
      provides: "Heart pulse animation keyframes"
      contains: "@keyframes heart-pulse"
    - path: "madplan-v2/src/components/ui/popover.tsx"
      provides: "Popover component for tag input"
      exports: ["Popover", "PopoverTrigger", "PopoverContent"]
  key_links:
    - from: "madplan-v2/src/app/api/madplan/opskrift/favorit/route.ts"
      to: "N8N_WEBHOOK_URL"
      via: "fetch to n8n webhook"
      pattern: "N8N_WEBHOOK_URL"
    - from: "madplan-v2/src/app/api/madplan/opskrift/tags/route.ts"
      to: "N8N_WEBHOOK_URL"
      via: "fetch to n8n webhook"
      pattern: "N8N_WEBHOOK_URL"
---

<objective>
Create foundation for organization features: extended types, API routes, CSS animation, and Popover component.

Purpose: Enable favorite and tag functionality by establishing the data types, backend routes, and UI primitives needed by subsequent plans.
Output: Types with favorit/tags, 2 API routes, heart animation CSS, Popover component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-organization/05-CONTEXT.md
@.planning/phases/05-organization/05-RESEARCH.md

# Existing files to modify
@madplan-v2/src/lib/types.ts
@madplan-v2/src/app/globals.css

# Reference for API route pattern
@madplan-v2/src/app/api/madplan/opskrift/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend types and add Popover component</name>
  <files>madplan-v2/src/lib/types.ts, madplan-v2/src/components/ui/popover.tsx</files>
  <action>
1. Update `types.ts`:
   - Add `favorit?: boolean` to Opskrift interface (optional because Airtable returns undefined for unchecked)
   - Add `tags?: string[]` to Opskrift interface (optional because Airtable omits empty arrays)
   - Add `favorit?: boolean` to OpskriftInput interface
   - Add `tags?: string[]` to OpskriftInput interface

2. Install Popover component from shadcn/ui:
   Run: `npx shadcn@latest add popover`
   This installs @radix-ui/react-popover and creates popover.tsx

Note: Airtable checkbox fields return undefined (not false) when unchecked, and multi-select returns undefined when empty. Always use `recipe.favorit ?? false` and `recipe.tags ?? []` when consuming.
  </action>
  <verify>
    - `grep -n "favorit" madplan-v2/src/lib/types.ts` shows favorit field in both interfaces
    - `grep -n "tags" madplan-v2/src/lib/types.ts` shows tags field in both interfaces
    - `test -f madplan-v2/src/components/ui/popover.tsx` confirms popover exists
  </verify>
  <done>Types extended with favorit/tags, Popover component installed</done>
</task>

<task type="auto">
  <name>Task 2: Create API routes and CSS animation</name>
  <files>madplan-v2/src/app/api/madplan/opskrift/favorit/route.ts, madplan-v2/src/app/api/madplan/opskrift/tags/route.ts, madplan-v2/src/app/globals.css</files>
  <action>
1. Create `favorit/route.ts`:
   - POST handler accepting `{ opskriftId: string, favorit: boolean }`
   - Proxy to n8n webhook: `${N8N_WEBHOOK_URL}/opdater-opskrift` (same as existing update endpoint)
   - Body: `{ opskriftId, fields: { Favorit: favorit } }`
   - Return `{ success: true }` or error response
   - Follow existing route pattern in opskrift/route.ts

2. Create `tags/route.ts`:
   - POST handler accepting `{ opskriftId: string, tags: string[] }`
   - Proxy to n8n webhook: `${N8N_WEBHOOK_URL}/opdater-opskrift`
   - Body: `{ opskriftId, fields: { Tags: tags } }` (Airtable multi-select expects array)
   - Return `{ success: true }` or error response

3. Add to `globals.css` (after existing animations):
   ```css
   @keyframes heart-pulse {
     0% { transform: scale(1); }
     25% { transform: scale(1.2); }
     50% { transform: scale(1); }
     75% { transform: scale(1.1); }
     100% { transform: scale(1); }
   }

   .animate-heart-pulse {
     animation: heart-pulse 0.4s ease-in-out;
   }
   ```

Note on n8n: The existing "Opdater Opskrift" workflow should accept partial updates. If it doesn't work, user will need to update n8n workflow to handle Favorit and Tags fields.
  </action>
  <verify>
    - `curl -X POST http://localhost:3000/api/madplan/opskrift/favorit -H "Content-Type: application/json" -d '{"opskriftId":"test","favorit":true}'` returns JSON (may error if no n8n)
    - `curl -X POST http://localhost:3000/api/madplan/opskrift/tags -H "Content-Type: application/json" -d '{"opskriftId":"test","tags":["test"]}'` returns JSON
    - `grep -n "heart-pulse" madplan-v2/src/app/globals.css` shows animation
  </verify>
  <done>Favorite API route works, Tags API route works, Heart animation CSS defined</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd madplan-v2 && npm run build` passes
2. Types include new fields: `grep "favorit\|tags" src/lib/types.ts` shows both
3. API routes exist: `ls src/app/api/madplan/opskrift/*/route.ts` shows favorit and tags
4. Animation defined: `grep "animate-heart-pulse" src/app/globals.css` shows class
5. Popover ready: `test -f src/components/ui/popover.tsx` passes
</verification>

<success_criteria>
- Opskrift type has optional favorit (boolean) and tags (string[]) fields
- OpskriftInput type has optional favorit and tags fields
- POST /api/madplan/opskrift/favorit accepts opskriftId + favorit boolean
- POST /api/madplan/opskrift/tags accepts opskriftId + tags array
- CSS animation `animate-heart-pulse` defined in globals.css
- Popover component available for tag input combobox
</success_criteria>

<output>
After completion, create `.planning/phases/05-organization/05-01-SUMMARY.md`
</output>
