---
phase: 05-organization
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - madplan-v2/src/components/opskrifter/favorite-button.tsx
  - madplan-v2/src/hooks/use-opskrifter.ts
  - madplan-v2/src/components/opskrifter/recipe-card.tsx
  - madplan-v2/src/components/opskrifter/recipe-list-item.tsx
  - madplan-v2/src/app/opskrifter/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can tap heart to toggle favorite on recipe cards"
    - "User can tap heart to toggle favorite on recipe list items"
    - "User can tap heart to toggle favorite on recipe detail page"
    - "Heart fills instantly with pulse animation when favorited"
    - "Favorite toggle persists to backend"
  artifacts:
    - path: "madplan-v2/src/components/opskrifter/favorite-button.tsx"
      provides: "Reusable heart toggle component"
      exports: ["FavoriteButton"]
      min_lines: 30
    - path: "madplan-v2/src/hooks/use-opskrifter.ts"
      provides: "toggleFavorite function with optimistic update"
      contains: "toggleFavorite"
    - path: "madplan-v2/src/components/opskrifter/recipe-card.tsx"
      provides: "Card with favorite button overlay"
      contains: "FavoriteButton"
    - path: "madplan-v2/src/components/opskrifter/recipe-list-item.tsx"
      provides: "List item with favorite button"
      contains: "FavoriteButton"
    - path: "madplan-v2/src/app/opskrifter/[id]/page.tsx"
      provides: "Detail page with favorite button in header"
      contains: "FavoriteButton"
  key_links:
    - from: "madplan-v2/src/components/opskrifter/favorite-button.tsx"
      to: "onClick callback"
      via: "onToggle prop"
      pattern: "onToggle\\(\\)"
    - from: "madplan-v2/src/hooks/use-opskrifter.ts"
      to: "/api/madplan/opskrift/favorit"
      via: "fetch POST"
      pattern: "api/madplan/opskrift/favorit"
    - from: "madplan-v2/src/components/opskrifter/recipe-card.tsx"
      to: "madplan-v2/src/components/opskrifter/favorite-button.tsx"
      via: "component import"
      pattern: "import.*FavoriteButton"
---

<objective>
Implement favorite marking for recipes with optimistic updates and pulse animation.

Purpose: Enable users to mark recipes as favorites (ORG-01) with instant visual feedback and persistence.
Output: FavoriteButton component, extended hook with toggleFavorite, integrated cards/list/detail.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-organization/05-CONTEXT.md
@.planning/phases/05-organization/05-RESEARCH.md
@.planning/phases/05-organization/05-01-SUMMARY.md

# Files to modify
@madplan-v2/src/hooks/use-opskrifter.ts
@madplan-v2/src/components/opskrifter/recipe-card.tsx
@madplan-v2/src/components/opskrifter/recipe-list-item.tsx
@madplan-v2/src/app/opskrifter/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FavoriteButton and extend hook</name>
  <files>madplan-v2/src/components/opskrifter/favorite-button.tsx, madplan-v2/src/hooks/use-opskrifter.ts</files>
  <action>
1. Create `favorite-button.tsx`:
   ```typescript
   'use client'

   import { useState, useEffect } from 'react'
   import { Heart } from 'lucide-react'
   import { cn } from '@/lib/utils'

   interface FavoriteButtonProps {
     isFavorite: boolean
     onToggle: () => void
     className?: string
     size?: 'sm' | 'md'
   }

   export function FavoriteButton({ isFavorite, onToggle, className, size = 'md' }: FavoriteButtonProps) {
     const [animating, setAnimating] = useState(false)

     // Trigger animation when favorited (not unfavorited)
     useEffect(() => {
       if (isFavorite) {
         setAnimating(true)
         const timer = setTimeout(() => setAnimating(false), 400)
         return () => clearTimeout(timer)
       }
     }, [isFavorite])

     const iconSize = size === 'sm' ? 'h-4 w-4' : 'h-5 w-5'
     const padding = size === 'sm' ? 'p-1.5' : 'p-2'

     return (
       <button
         onClick={(e) => {
           e.preventDefault()
           e.stopPropagation()
           onToggle()
         }}
         className={cn(
           padding,
           "rounded-full bg-white/80 backdrop-blur-sm",
           "hover:bg-white transition-colors",
           "focus:outline-none focus-visible:ring-2 focus-visible:ring-terracotta-400",
           className
         )}
         aria-label={isFavorite ? "Fjern fra favoritter" : "Tilfoej til favoritter"}
       >
         <Heart
           className={cn(
             iconSize,
             "transition-all duration-200",
             animating && "animate-heart-pulse",
             isFavorite
               ? "fill-terracotta-500 text-terracotta-500"
               : "text-sand-600"
           )}
         />
       </button>
     )
   }
   ```

2. Extend `use-opskrifter.ts`:
   - Add toggleFavorite function with SWR optimistic update
   - Use mutate() with optimistic data and rollbackOnError
   - POST to /api/madplan/opskrift/favorit

   ```typescript
   import useSWR, { mutate as globalMutate } from 'swr'
   import type { Opskrift } from '@/lib/types'

   export function useOpskrifter(ejerId: string | null) {
     const cacheKey = ejerId ? `/api/madplan/opskrifter?ejerId=${ejerId}` : null
     const { data, error, isLoading, mutate } = useSWR<Opskrift[]>(cacheKey)

     const toggleFavorite = async (opskriftId: string) => {
       if (!cacheKey || !data) return

       const currentRecipe = data.find((o) => o.id === opskriftId)
       if (!currentRecipe) return

       const newFavorit = !(currentRecipe.favorit ?? false)

       // Optimistic update
       mutate(
         data.map((o) =>
           o.id === opskriftId ? { ...o, favorit: newFavorit } : o
         ),
         {
           revalidate: false,
           rollbackOnError: true,
         }
       )

       // Server sync
       try {
         const response = await fetch('/api/madplan/opskrift/favorit', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ opskriftId, favorit: newFavorit }),
         })
         if (!response.ok) throw new Error('Failed to toggle favorite')
       } catch (error) {
         // SWR will rollback on error
         console.error('Toggle favorite error:', error)
         throw error
       }
     }

     return {
       opskrifter: data ?? [],
       isLoading,
       isError: !!error,
       error,
       mutate,
       toggleFavorite,
     }
   }
   ```

Key points:
- Animation triggers on isFavorite becoming true
- e.preventDefault() + e.stopPropagation() prevents card navigation
- Coalesce favorit ?? false for undefined handling
- No toast per CONTEXT.md - animation is feedback
  </action>
  <verify>
    - `grep -n "FavoriteButton" madplan-v2/src/components/opskrifter/favorite-button.tsx` shows export
    - `grep -n "toggleFavorite" madplan-v2/src/hooks/use-opskrifter.ts` shows function
    - TypeScript compiles: `cd madplan-v2 && npx tsc --noEmit`
  </verify>
  <done>FavoriteButton component created, hook extended with toggleFavorite</done>
</task>

<task type="auto">
  <name>Task 2: Integrate favorites into cards, list, and detail page</name>
  <files>madplan-v2/src/components/opskrifter/recipe-card.tsx, madplan-v2/src/components/opskrifter/recipe-list-item.tsx, madplan-v2/src/app/opskrifter/[id]/page.tsx</files>
  <action>
1. Update `recipe-card.tsx`:
   - Accept onToggleFavorite prop
   - Position FavoriteButton in top-right corner of image area
   - Use absolute positioning over the image/placeholder

   ```typescript
   interface RecipeCardProps {
     recipe: Opskrift
     onToggleFavorite?: () => void
   }

   export function RecipeCard({ recipe, onToggleFavorite }: RecipeCardProps) {
     // ... existing code
     // Add relative to card wrapper, absolute button in top-right
     <div className="relative">
       {/* Image or placeholder */}
       {onToggleFavorite && (
         <FavoriteButton
           isFavorite={recipe.favorit ?? false}
           onToggle={onToggleFavorite}
           className="absolute top-2 right-2 z-10"
           size="sm"
         />
       )}
     </div>
   }
   ```

2. Update `recipe-list-item.tsx`:
   - Accept onToggleFavorite prop
   - Add FavoriteButton before chevron (right side)

   ```typescript
   interface RecipeListItemProps {
     recipe: Opskrift
     onToggleFavorite?: () => void
   }
   // Add FavoriteButton between content and chevron
   {onToggleFavorite && (
     <FavoriteButton
       isFavorite={recipe.favorit ?? false}
       onToggle={onToggleFavorite}
       size="sm"
     />
   )}
   ```

3. Update `[id]/page.tsx`:
   - Import useOpskrifter hook
   - Add FavoriteButton in header section next to title
   - Use toggleFavorite from hook

   ```typescript
   const { opskrifter, toggleFavorite } = useOpskrifter(ejerId)
   const opskrift = opskrifter.find((o) => o.id === opskriftId)

   // In header area, after title:
   <FavoriteButton
     isFavorite={opskrift.favorit ?? false}
     onToggle={() => toggleFavorite(opskriftId)}
   />
   ```

Note: The opskrifter page will need to pass toggleFavorite to cards/list in a later task (part of filter integration).
  </action>
  <verify>
    - `grep -n "FavoriteButton" madplan-v2/src/components/opskrifter/recipe-card.tsx` shows import and usage
    - `grep -n "FavoriteButton" madplan-v2/src/components/opskrifter/recipe-list-item.tsx` shows import and usage
    - `grep -n "FavoriteButton" madplan-v2/src/app/opskrifter/[id]/page.tsx` shows import and usage
    - Dev server runs: `npm run dev` works without errors
  </verify>
  <done>FavoriteButton integrated into all recipe views</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd madplan-v2 && npm run build` passes
2. FavoriteButton exported: `grep "export.*FavoriteButton" src/components/opskrifter/favorite-button.tsx`
3. Hook has toggleFavorite: `grep "toggleFavorite" src/hooks/use-opskrifter.ts`
4. Integration complete:
   - `grep "FavoriteButton" src/components/opskrifter/recipe-card.tsx`
   - `grep "FavoriteButton" src/components/opskrifter/recipe-list-item.tsx`
   - `grep "FavoriteButton" src/app/opskrifter/[id]/page.tsx`
</verification>

<success_criteria>
- FavoriteButton shows heart icon that fills when favorited
- Heart animates with pulse on favorite (not unfavorite)
- Clicking heart on recipe card toggles favorite without navigating
- Clicking heart on list item toggles favorite without navigating
- Recipe detail page shows favorite button next to title
- Favorites persist via API (optimistic update with rollback)
</success_criteria>

<output>
After completion, create `.planning/phases/05-organization/05-02-SUMMARY.md`
</output>
